<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>åœ–ç‰‡å„ªåŒ–èˆ‡ Base64 ç·¨ç¢¼ç¯„ä¾‹ (ä¿®æ­£ç‰ˆ)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 800px; margin: 0 auto; padding: 25px; background-color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 10px; }
        #output-area { margin-top: 25px; padding: 20px; background-color: #e9ecef; border-radius: 6px; }
        .stats p { margin: 8px 0; font-size: 1.1em; }
        .stats strong { color: #d9534f; font-weight: bold; }
        textarea { width: 100%; box-sizing: border-box; resize: vertical; border: 1px solid #ccc; padding: 8px; border-radius: 4px; }
        .alert-message { color: #3c763d; background-color: #dff0d8; border: 1px solid #d6e9c6; padding: 10px; margin-top: 15px; border-radius: 4px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ–¼ï¸ åœ–ç‰‡ä¸Šå‚³å„ªåŒ–èˆ‡ Base64 ç·¨ç¢¼</h1>
    <p>è¨­å®šå„ªåŒ–åƒæ•¸ï¼šæœ€å¤§å¯¬åº¦ <strong id="paramWidth">800px</strong>ï¼ŒJPEG è³ªé‡ <strong id="paramQuality">70%</strong>ã€‚</p>
    
    <input type="file" id="imageInput" accept="image/*">
    
    <div class="alert-message" id="successMessage">âœ… åœ–ç‰‡è™•ç†å®Œæˆï¼è«‹æŸ¥çœ‹ä¸‹æ–¹æ•¸æ“šã€‚</div>
    
    <div id="output-area">
        <h3>ğŸ“Š è™•ç†çµ±è¨ˆ</h3>
        <div class="stats">
            <p>åŸå§‹æª”æ¡ˆå¤§å°ï¼š<strong id="originalSize">0 KB</strong></p>
            <p>Base64 å­—ä¸²é•·åº¦ (å‚³è¼¸å¤§å°)ï¼š<strong id="base64Length">0 KB</strong></p>
            <p>ğŸŒŸ æª”æ¡ˆå„ªåŒ–æ•ˆæœï¼š<strong id="compressionRatio">N/A</strong></p>
        </div>
        
        <hr>
        
        <h4>Base64 å‚³è¼¸æ•¸æ“š (é–‹é ­ç¯„ä¾‹)</h4>
        <textarea id="base64Output" rows="5" readonly placeholder="Base64 å­—ä¸²å°‡é¡¯ç¤ºåœ¨é€™è£¡..."></textarea>
        
        <h4>å„ªåŒ–å¾Œçš„åœ–ç‰‡é è¦½</h4>
        <img id="previewImage" src="" alt="åœ–ç‰‡é è¦½" style="max-width: 100%; height: auto; margin-top: 10px; border: 1px solid #ddd; display: none;">
    </div>
</div>

<script>
// --- é…ç½®åƒæ•¸ ---
const MAX_WIDTH = 800; // åœ–ç‰‡æœ€å¤§å¯¬åº¦
const JPEG_QUALITY = 0.7; // åœ–ç‰‡è¼¸å‡ºå“è³ª (0.0 åˆ° 1.0)

// æ›´æ–°é¡¯ç¤ºçš„åƒæ•¸
document.getElementById('paramWidth').textContent = `${MAX_WIDTH}px`;
document.getElementById('paramQuality').textContent = `${JPEG_QUALITY * 100}%`;

document.getElementById('imageInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (!file || !file.type.startsWith('image/')) {
        alert('è«‹é¸æ“‡æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆã€‚');
        return;
    }

    // é¡¯ç¤ºåŸå§‹æª”æ¡ˆå¤§å°
    const originalSizeKB = file.size / 1024;
    document.getElementById('originalSize').textContent = `${originalSizeKB.toFixed(2)} KB`;
    document.getElementById('successMessage').style.display = 'none'; // è™•ç†å‰éš±è—æç¤º

    const reader = new FileReader();
    reader.onload = function(e) {
        const originalDataUrl = e.target.result;
        // å‘¼å«åœ–ç‰‡å„ªåŒ–å‡½æ•¸
        optimizeImage(originalDataUrl, originalSizeKB); 
    };

    reader.onerror = function() {
        alert('è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚');
    };

    // ä»¥ Data URL æ ¼å¼è®€å–æª”æ¡ˆ
    reader.readAsDataURL(file);
});


/**
 * åœ–ç‰‡å„ªåŒ–å‡½æ•¸ï¼šèª¿æ•´å°ºå¯¸ä¸¦é‡æ–°ç·¨ç¢¼ (å„ªåŒ–çš„é—œéµ)
 * @param {string} dataURL - åŸå§‹åœ–ç‰‡çš„ Data URL
 * @param {number} originalSizeKB - åŸå§‹æª”æ¡ˆå¤§å° (KB)
 */
function optimizeImage(dataURL, originalSizeKB) {
    const img = new Image();
    img.onload = function() {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;

        // 1. èª¿æ•´å°ºå¯¸ (ç­‰æ¯”ä¾‹ç¸®å°)
        if (width > MAX_WIDTH) {
            height = Math.round(height * (MAX_WIDTH / width));
            width = MAX_WIDTH;
        }

        canvas.width = width;
        canvas.height = height;

        const ctx = canvas.getContext('2d');
        // ç¢ºä¿åœ–ç‰‡ç¹ªè£½æ˜¯å¹³æ»‘çš„
        ctx.drawImage(img, 0, 0, width, height);

        // 2. Base64 ç·¨ç¢¼èˆ‡å„ªåŒ– (ç¢ºä¿ä¸æœƒäº‚ç¢¼)
        // ä½¿ç”¨ JPEG æ ¼å¼å’Œè¨­å®šçš„å“è³ªåƒæ•¸é€²è¡Œ Base64 è¼¸å‡º
        const optimizedDataURL = canvas.toDataURL('image/jpeg', JPEG_QUALITY);

        // 3. è™•ç†çµæœ
        displayBase64Result(optimizedDataURL, originalSizeKB);
    };
    
    img.onerror = function() {
        alert("åœ–ç‰‡åŠ è¼‰å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæœ‰æ•ˆæ€§ã€‚");
    }

    img.src = dataURL; // é–‹å§‹åŠ è¼‰åœ–ç‰‡
}

/**
 * é¡¯ç¤º Base64 è™•ç†çµæœå’Œå£“ç¸®çµ±è¨ˆ
 * @param {string} base64DataUrl - å„ªåŒ–å¾Œçš„ Base64 Data URL
 * @param {number} originalSizeKB - åŸå§‹æª”æ¡ˆå¤§å° (KB)
 */
function displayBase64Result(base64DataUrl, originalSizeKB) {
    // ç§»é™¤ Data URL å‰ç¶´ (ä¾‹å¦‚: "data:image/jpeg;base64,")
    const base64String = base64DataUrl.split(',')[1];
    
    // Base64 å­—ä¸²çš„é•·åº¦ï¼Œé€™å°±æ˜¯å¯¦éš›å‚³è¼¸çš„å­—ç¯€æ•¸
    const base64LenKB = base64String.length / 1024;
    document.getElementById('base64Length').textContent = `${base64LenKB.toFixed(2)} KB`;

    // è¨ˆç®—å£“ç¸®æ¯” (Base64 æ¯”åŸå§‹äºŒé€²åˆ¶æ•¸æ“šå¤§ç´„å¤š 33%)
    // å‚³è¼¸å¤§å° vs. åŸå§‹æª”æ¡ˆå¤§å°
    const reduction = originalSizeKB - base64LenKB; 
    const compressionRatio = ((originalSizeKB - base64LenKB) / originalSizeKB) * 100;
    
    let ratioText;
    if (reduction > 0) {
        // å¦‚æœ Base64 å­—ä¸²å¤§å°å°æ–¼åŸå§‹æª”æ¡ˆå¤§å°ï¼Œä»£è¡¨å„ªåŒ–æˆåŠŸ (é€šå¸¸ç™¼ç”Ÿåœ¨åŸå§‹åœ–ç‰‡æ˜¯æœªå£“ç¸®çš„ PNG æ™‚)
        ratioText = `æª”æ¡ˆç¸®å° ${Math.abs(compressionRatio).toFixed(2)}%`;
        document.getElementById('compressionRatio').style.color = '#28a745'; // ç¶ è‰²
    } else {
        // Base64 ç·¨ç¢¼æœ¬èº«æœƒå¢å¤§æª”æ¡ˆ (ç´„ 33%)ã€‚å¦‚æœæœ€çµ‚ Base64 ä»å¤§æ–¼åŸå§‹æª”æ¡ˆï¼Œè¡¨ç¤ºåŸåœ–å·²ç¶“å¾ˆå°æˆ–åƒæ•¸è¨­ç½®éé«˜ã€‚
        ratioText = `æª”æ¡ˆå¢å¤§ ${Math.abs(compressionRatio).toFixed(2)}%`;
        document.getElementById('compressionRatio').style.color = '#ffc107'; // é»ƒè‰²
    }
    
    document.getElementById('compressionRatio').textContent = ratioText;

    // é¡¯ç¤º Base64 å­—ç¬¦ä¸²
    document.getElementById('base64Output').value = base64DataUrl.substring(0, 150) + '... (å·²çœç•¥ï¼Œå®Œæ•´å­—ä¸²é•·åº¦ç´„ ' + base64LenKB.toFixed(2) + ' KB)';

    // é¡¯ç¤ºé è¦½åœ–ç‰‡
    const preview = document.getElementById('previewImage');
    preview.src = base64DataUrl;
    preview.style.display = 'block';
    
    document.getElementById('successMessage').style.display = 'block'; // è™•ç†å®Œæˆï¼Œé¡¯ç¤ºæç¤º
}
</script>

</body>
</html>
