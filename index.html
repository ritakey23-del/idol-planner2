<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆ‘çš„è¿½æ˜Ÿæ—¥è¨˜ ğŸŒŸ | è¿½æ˜Ÿè¡Œç¨‹ç®¡ç†ã€è²»ç”¨ç´€éŒ„èˆ‡åœ°åœ–è¶³è·¡</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/bold/style.css" />
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/fill/style.css" />
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/regular/style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--primary-color)',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', '"Quicksand"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        :root { --primary-color: #63b3b0; }
        body { background-color: #f8fafc; height: 100dvh; width: 100vw; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        #map-container { height: 100%; width: 100%; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
    </style>
</head>
<body class="text-slate-700 antialiased flex flex-col">

    <div id="app" :style="cssVars" class="h-full flex flex-col relative w-full">

        <header :class="isThemeColorLight ? 'text-slate-800' : 'text-white'" 
                class="pt-4 pb-4 px-5 shadow-lg rounded-b-[1.5rem] z-20 shrink-0 transition-colors duration-200"
                :style="{ backgroundColor: themeColor }">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold tracking-wide">{{ customTitle }}</h1>
                    <p class="text-xs opacity-90">{{ greetingMessage }}</p>
                </div>
                <div @click="toggleSettingsModal" class="p-2 rounded-full bg-white/20 backdrop-blur-sm cursor-pointer">
                    <i class="ph ph-gear text-lg"></i>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar bg-slate-50 relative">
            
            <div v-if="activeTab === 'home'" class="p-5 space-y-4 pb-32">
                <div class="relative mb-4">
                    <i class="ph ph-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
                    <input v-model="searchQuery" type="text" placeholder="æœå°‹è¡Œç¨‹..." class="w-full bg-white border border-slate-200 rounded-xl py-2 pl-10 pr-4 text-sm">
                </div>
                <div v-for="event in filteredEvents" :key="event.id" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center">
                    <div>
                        <div class="text-[10px] font-bold px-2 py-0.5 rounded inline-block text-white" :style="{ backgroundColor: getEventColor(event) }">{{ event.artist }}</div>
                        <h3 class="font-bold text-slate-800 mt-1">{{ event.title }}</h3>
                        <p class="text-xs text-slate-400">{{ event.date }} {{ event.time }}</p>
                    </div>
                    <span class="text-2xl">{{ event.sticker }}</span>
                </div>
            </div>

            <div v-if="activeTab === 'calendar'" class="p-5 space-y-4 pb-32">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-bold text-slate-800">{{ currentMonthYear }}</h2>
                    <div class="flex gap-2">
                        <button @click="prevMonth" class="p-2 bg-white rounded-full shadow-sm border border-slate-100"><i class="ph ph-caret-left"></i></button>
                        <button @click="nextMonth" class="p-2 bg-white rounded-full shadow-sm border border-slate-100"><i class="ph ph-caret-right"></i></button>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-4 shadow-sm border border-slate-100">
                    <div class="calendar-grid text-center mb-2">
                        <div v-for="d in ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']" class="text-[10px] font-bold text-slate-400">{{ d }}</div>
                    </div>
                    <div class="calendar-grid gap-1">
                        <div v-for="(dateObj, idx) in calendarDays" :key="idx" 
                             class="aspect-square flex flex-col items-center justify-start p-1 rounded-xl transition-colors relative"
                             :class="[dateObj.isCurrentMonth ? 'text-slate-700' : 'text-slate-200', dateObj.isToday ? 'ring-2 ring-primary ring-inset font-bold' : '']">
                            <span class="text-xs">{{ dateObj.day }}</span>
                            <div class="flex flex-wrap justify-center gap-0.5 mt-0.5">
                                <span v-for="e in dateObj.events.slice(0,2)" :key="e.id" class="text-[10px]">{{ e.sticker || 'ğŸ«' }}</span>
                                <div v-if="dateObj.events.length > 2" class="w-1 h-1 rounded-full bg-primary self-center"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-slate-400 tracking-widest uppercase">æœ¬æœˆè¡Œç¨‹</h3>
                    <div v-if="currentMonthEvents.length === 0" class="text-center py-8 text-slate-400 text-sm">æœ¬æœˆå°šç„¡å®‰æ’è¡Œç¨‹ ğŸ˜´</div>
                    <div v-for="e in currentMonthEvents" :key="e.id" class="bg-white p-3 rounded-2xl border border-slate-100 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl flex flex-col items-center justify-center shrink-0 font-bold" :style="{ backgroundColor: getEventColor(e) + '20', color: getEventColor(e) }">
                            <span class="text-[10px] uppercase">{{ getMonth(e.date) }}</span>
                            <span class="text-sm">{{ getDay(e.date) }}</span>
                        </div>
                        <div class="flex-1 truncate">
                            <h4 class="text-sm font-bold text-slate-800 truncate">{{ e.title }}</h4>
                            <p class="text-[10px] text-slate-400">{{ e.location }}</p>
                        </div>
                        <span class="text-xl">{{ e.sticker }}</span>
                    </div>
                </div>
            </div>

            <div v-show="activeTab === 'map'" class="w-full h-full"><div id="map-container"></div></div>
            <div v-if="activeTab === 'stats'" class="p-5">çµ±è¨ˆå›é¡§å€åŸŸ</div>
            <div v-if="activeTab === 'fandom'" class="p-5">ç´€å¿µæ—¥å€åŸŸ</div>
        </main>

        <button @click="openModal()" :style="{ backgroundColor: themeColor }"
            class="absolute bottom-24 right-6 w-14 h-14 text-white rounded-full shadow-lg flex items-center justify-center z-30 mb-safe"
            v-if="['home', 'calendar'].includes(activeTab)">
            <i class="ph ph-plus text-2xl font-bold"></i>
        </button>

        <nav class="bg-white border-t border-slate-100 px-4 py-3 flex justify-between items-center safe-pb z-40">
            <button @click="activeTab = 'home'" class="flex flex-col items-center gap-1 w-14" :style="{ color: activeTab === 'home' ? themeColor : '#94a3b8' }">
                <i class="ph-bold ph-list-bullets text-2xl"></i>
                <span class="text-[10px] font-medium">åˆ—è¡¨</span>
            </button>
            <button @click="activeTab = 'calendar'" class="flex flex-col items-center gap-1 w-14" :style="{ color: activeTab === 'calendar' ? themeColor : '#94a3b8' }">
                <i class="ph-bold ph-calendar text-2xl"></i>
                <span class="text-[10px] font-medium">æœˆæ›†</span>
            </button>
            <button @click="activeTab = 'fandom'" class="flex flex-col items-center gap-1 w-14" :style="{ color: activeTab === 'fandom' ? themeColor : '#94a3b8' }">
                <i class="ph-bold ph-heart text-2xl"></i>
                <span class="text-[10px] font-medium">ç´€å¿µæ—¥</span>
            </button>
            <button @click="activeTab = 'map'" class="flex flex-col items-center gap-1 w-14" :style="{ color: activeTab === 'map' ? themeColor : '#94a3b8' }">
                <i class="ph-bold ph-map-trifold text-2xl"></i>
                <span class="text-[10px] font-medium">åœ°åœ–</span>
            </button>
            <button @click="activeTab = 'stats'" class="flex flex-col items-center gap-1 w-14" :style="{ color: activeTab === 'stats' ? themeColor : '#94a3b8' }">
                <i class="ph-bold ph-chart-bar text-2xl"></i>
                <span class="text-[10px] font-medium">å›é¡§</span>
            </button>
        </nav>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
        createApp({
            setup() {
                const events = ref(JSON.parse(localStorage.getItem('idolEvents') || '[]'));
                const activeTab = ref('home');
                const themeColor = ref(localStorage.getItem('idolTheme') || '#63b3b0');
                const calendarDate = ref(new Date());
                const searchQuery = ref('');
                const customTitle = ref(localStorage.getItem('appTitle') || 'è¿½æ˜Ÿæ—¥è¨˜ âœ¨');

                // æœˆæ›†é‚è¼¯
                const currentMonthYear = computed(() => `${calendarDate.value.getFullYear()}å¹´ ${calendarDate.value.getMonth() + 1}æœˆ`);
                const prevMonth = () => { calendarDate.value = new Date(calendarDate.value.getFullYear(), calendarDate.value.getMonth() - 1, 1); };
                const nextMonth = () => { calendarDate.value = new Date(calendarDate.value.getFullYear(), calendarDate.value.getMonth() + 1, 1); };
                
                const calendarDays = computed(() => {
                    const year = calendarDate.value.getFullYear();
                    const month = calendarDate.value.getMonth();
                    const firstDay = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const todayStr = new Date().toISOString().split('T')[0];
                    const days = [];
                    // è£œé½Šå‰ä¸€å€‹æœˆç©ºä½
                    for (let i = 0; i < firstDay; i++) days.push({ day: '', isCurrentMonth: false, events: [] });
                    // æœ¬æœˆæ—¥æœŸ
                    for (let d = 1; d <= daysInMonth; d++) {
                        const fullDate = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        days.push({ 
                            day: d, 
                            isCurrentMonth: true, 
                            isToday: fullDate === todayStr,
                            events: events.value.filter(e => e.date === fullDate)
                        });
                    }
                    return days;
                });

                const currentMonthEvents = computed(() => {
                    const ym = `${calendarDate.value.getFullYear()}-${String(calendarDate.value.getMonth()+1).padStart(2,'0')}`;
                    return events.value.filter(e => e.date.startsWith(ym)).sort((a,b) => new Date(a.date)-new Date(b.date));
                });

                const filteredEvents = computed(() => {
                    if (!searchQuery.value) return events.value;
                    return events.value.filter(e => e.title.includes(searchQuery.value) || e.artist.includes(searchQuery.value));
                });

                const getEventColor = (e) => e.color || themeColor.value;
                const getDay = (d) => new Date(d).getDate();
                const getMonth = (d) => ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][new Date(d).getMonth()];
                
                const isColorLight = (color) => {
                    const r = parseInt(color.substring(1, 3), 16);
                    const g = parseInt(color.substring(3, 5), 16);
                    const b = parseInt(color.substring(5, 7), 16);
                    return (r * 0.299 + g * 0.587 + b * 0.114) > 186;
                };

                return {
                    events, activeTab, themeColor, calendarDate, searchQuery, customTitle,
                    currentMonthYear, calendarDays, currentMonthEvents, filteredEvents,
                    prevMonth, nextMonth, getEventColor, getDay, getMonth,
                    isThemeColorLight: computed(() => isColorLight(themeColor.value)),
                    greetingMessage: "ä»Šå¤©ä¹Ÿè¦ç‚ºäº†è¦‹é¢åŠªåŠ›ç”Ÿæ´» âœ¨",
                    cssVars: computed(() => ({ '--primary-color': themeColor.value }))
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
