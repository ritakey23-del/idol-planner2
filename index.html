<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿½æ˜Ÿè¦åŠƒä¸­å¿ƒ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let unsubscribeEvents = null;
        let unsubscribeColors = null;
        let unsubscribeTheme = null;

        const { createApp, ref, computed, watch } = Vue;

        // é è¨­é¡è‰²å’Œæ‡‰æ´è‰²åˆ—è¡¨
        const DEFAULT_COLOR_CLASS = 'border-gray-400'; // Fallback
        const INITIAL_APP_THEME_HEX = '#4FBDBA'; // é è¨­çš„æ¹–æ°´ç¶  HEX è‰²ç¢¼

        // è¼”åŠ©å‡½æ•¸ï¼šå°‡ HEX è½‰æ›ç‚º RGB æ•¸çµ„
        const hexToRgb = (hex) => {
            const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b);
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [
                parseInt(result[1], 16),
                parseInt(result[2], 16),
                parseInt(result[3], 16)
            ] : [79, 189, 186]; // Fallback to aquamarine RGB
        };
        
        // è¼”åŠ©å‡½æ•¸ï¼šå°‡ HEX è½‰æ›ç‚º Tailwind Border Class
        const hexToBorderClass = (hex) => {
            return `border-[${hex.startsWith('#') ? hex : '#' + hex}]`;
        };

        const EventTracker = {
            setup() {
                // --- ç‹€æ…‹ç®¡ç† ---
                const isAuthReady = ref(false);
                const userId = ref(null);
                const loading = ref(true);
                const events = ref([]);
                const activeEventId = ref(null);
                const activeTab = ref('schedule'); 
                const selectedReviewYear = ref('all'); 
                const showExclusionDisclaimer = ref(false); 
                
                // Theme State
                const currentAppThemeHex = ref(INITIAL_APP_THEME_HEX);
                const newThemeSelectionHex = ref(INITIAL_APP_THEME_HEX);
                
                // Color State
                const fanColors = ref({}); 
                const showColorModal = ref(false);
                const newColorArtist = ref('');
                const newColorClass = ref('#EF4444'); // Default HEX 

                // Form States
                const newEventName = ref('');
                const newArtistName = ref('');
                const showEventModal = ref(false);
                const showEditModal = ref(false); 
                const showEntrySelectionModal = ref(false); // NEW: Entry Selection Modal
                const newEventDate = ref('');
                const newEventLocation = ref('');
                
                // NEW/MODIFIED Schedule/Expense fields
                const newSchedule = ref({ 
                    time: '09:00', 
                    location: '', 
                    description: '', 
                    expenseAmount: 0, 
                    expenseDescription: '' 
                });
                
                const newExpense = ref({ description: '', amount: 0 }); // Retained for convenience but unused in expense tab
                const newParticipant = ref('');
                const selectedFile = ref(null); 
                const isImporting = ref(false);
                const showImportModal = ref(false); 
                const showDailyItemModal = ref(false); 

                // ç·¨è¼¯è¡¨å–®çš„æš«å­˜ç‹€æ…‹ - ADDED baseTicketExpense
                const editEventForm = ref({
                    eventName: '',
                    artistName: '',
                    date: '',
                    mainLocation: '',
                    baseTicketExpense: 0, // NEW
                    id: null
                });

                // --- Methods / Utilities ---

                // UPDATED: ç²å–æ‡‰æ´è‰² Tailwind Class (ä½¿ç”¨ HEX ç¶å®š)
                const getFanColorClass = (artistName) => {
                    const hex = fanColors.value[artistName] || DEFAULT_COLOR_CLASS;
                    // å¦‚æœæ˜¯ HEX (#XXXXXX)ï¼Œå‰‡è¿”å› Tailwind JIT æ ¼å¼
                    if (hex.startsWith('#')) {
                        return hexToBorderClass(hex);
                    }
                    // å¦‚æœä¸æ˜¯ HEX (ä¾‹å¦‚ 'border-gray-400')ï¼Œå‰‡åŸæ¨£è¿”å›
                    return hex;
                };
                
                const applyTheme = (hexColor) => {
                    const root = document.documentElement.style;
                    const [r, g, b] = hexToRgb(hexColor);
                    
                    // Set primary theme color variables based on the user's HEX input
                    root.setProperty('--theme-hex', hexColor);
                    root.setProperty('--theme-rgb', `${r}, ${g}, ${b}`);
                    root.setProperty('--theme-50', `rgba(${r}, ${g}, ${b}, 0.05)`); // Lightest background
                    root.setProperty('--theme-100', `rgba(${r}, ${g}, ${b}, 0.1)`);
                    root.setProperty('--theme-400', `rgba(${r}, ${g}, ${b}, 0.6)`); // Used for borders, lighter elements
                    root.setProperty('--theme-500', `rgba(${r}, ${g}, ${b}, 0.8)`); // Main buttons/nav color
                    root.setProperty('--theme-600', `rgba(${r}, ${g}, ${b}, 0.9)`);
                    root.setProperty('--theme-700', `rgba(${r}, ${g}, ${b}, 1)`); // Text color
                    root.setProperty('--theme-800', `rgba(${r}, ${g}, ${b}, 1)`); // Text/Accent color
                    
                    currentAppThemeHex.value = hexColor;
                };

                // --- Computed å±¬æ€§ ---
                
                const today = computed(() => new Date().toISOString().split('T')[0]);

                const currentEvent = computed(() => {
                    return events.value.find(e => e.id === activeEventId.value);
                });

                const eventYears = computed(() => {
                    return [...new Set(events.value.map(e => e.year))].sort((a, b) => b - a);
                });
                
                const upcomingEvents = computed(() => {
                    if (!Array.isArray(events.value)) return []; // FIX 1
                    return events.value.filter(e => e.date && e.date >= today.value).sort((a, b) => a.date.localeCompare(b.date));
                });

                const pastEvents = computed(() => {
                    if (!Array.isArray(events.value)) return []; // FIX 1
                    return events.value.filter(e => e.date && e.date < today.value).sort((a, b) => b.date.localeCompare(a.date));
                });


                const mapLink = computed(() => {
                    const event = currentEvent.value;
                    if (!event) return null;
                    let locationToSearch = '';
                    let sourceText = '';
                    if (event.mainLocation) {
                        locationToSearch = event.mainLocation;
                        sourceText = 'ä¸»è¦åœ°é»';
                    } 
                    else if (event.dailyItems && event.dailyItems.length > 0 && event.dailyItems[event.dailyItems.length - 1].location) {
                        locationToSearch = event.dailyItems[event.dailyItems.length - 1].location;
                        sourceText = 'æœ€å¾Œä¸€ç«™';
                    }
                    if (locationToSearch) {
                        return {
                            url: `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(locationToSearch)}`,
                            source: sourceText
                        };
                    }
                    return null;
                });

                // --- Review/Stats Logic ---
                
                const eventsInSelectedScope = computed(() => {
                    if (!Array.isArray(events.value)) return []; // FIX 1
                    return events.value.filter(event => 
                        selectedReviewYear.value === 'all' || event.year === parseInt(selectedReviewYear.value)
                    ).sort((a, b) => b.date.localeCompare(a.date)); 
                });

                const achievementsEvents = computed(() => {
                    const EXCLUDED_KEYWORDS = ['ì‚¬ì „ë…¹í™”', 'äº‹å‰éŒ„è£½', 'ç°½å”®æœƒ', 'ç°½åæœƒ', 'éŒ„è£½'];
                    const eventsToFilter = eventsInSelectedScope.value;

                    return eventsToFilter.filter(event => 
                        !EXCLUDED_KEYWORDS.some(keyword => event.eventName && event.eventName.includes(keyword))
                    );
                });

                const overallStats = computed(() => {
                    const eventList = achievementsEvents.value; 
                    const totalEventsAll = eventsInSelectedScope.value.length; 
                    
                    if (eventList.length === 0) {
                        return {
                            totalEventsAll: totalEventsAll,
                            totalEventsFiltered: 0,
                            uniqueArtists: 0,
                            artistBreakdown: [],
                            eventRepetitionBreakdown: [],
                            totalExpense: 0, 
                            avgExpensePerEvent: 0, 
                            expenseBreakdown: [],
                        };
                    }
                    
                    const totalEventsFiltered = eventList.length;
                    const artists = {};
                    const eventNames = {};
                    let totalExpense = 0; 

                    const expenseBreakdown = {};
                    for (const event of eventsInSelectedScope.value) {
                        // MODIFIED: Sum expenses from dailyItems/expenseAmount AND baseTicketExpense
                        const dailyTotal = event.dailyItems 
                            ? event.dailyItems.reduce((sum, item) => sum + (item.expenseAmount || 0), 0) 
                            : 0;
                        const ticketExpense = parseFloat(event.baseTicketExpense || 0); // NEW
                        const eventTotal = dailyTotal + ticketExpense;

                        totalExpense += eventTotal;
                        
                        const year = event.year;
                        expenseBreakdown[year] = (expenseBreakdown[year] || 0) + eventTotal;
                    }

                    // Tally Achivement Events data
                    for (const event of eventList) {
                        const artist = event.artistName || 'æœªçŸ¥æ­Œæ‰‹';
                        artists[artist] = (artists[artist] || 0) + 1;
                        const eventName = event.eventName || 'æœªçŸ¥æ´»å‹•';
                        eventNames[eventName] = (eventNames[eventName] || 0) + 1;
                    }


                    const uniqueArtists = Object.keys(artists).length;
                    const avgExpensePerEvent = totalEventsAll > 0 ? (totalExpense / totalEventsAll).toFixed(0) : 0;
                    
                    const artistBreakdown = Object.entries(artists)
                        .map(([name, count]) => ({ name, count }))
                        .sort((a, b) => b.count - a.count);

                    const eventRepetitionBreakdown = Object.entries(eventNames)
                        .map(([name, count]) => ({ name, count }))
                        .filter(item => item.count > 1) 
                        .sort((a, b) => b.count - a.count);

                    return {
                        totalEventsAll,
                        totalEventsFiltered,
                        uniqueArtists,
                        artistBreakdown,
                        eventRepetitionBreakdown,
                        totalExpense: totalExpense.toFixed(2),
                        avgExpensePerEvent,
                        expenseBreakdown,
                    };
                });


                // --- è¨˜å¸³é‚è¼¯ ---
                const expenseSummary = computed(() => {
                    const event = currentEvent.value;
                    if (!event || !event.dailyItems) {
                        return { totalSpent: 0 };
                    }
                    // MODIFIED: Sum expenses from dailyItems/expenseAmount AND baseTicketExpense
                    const dailyTotal = event.dailyItems.reduce((sum, item) => sum + (item.expenseAmount || 0), 0);
                    const ticketExpense = parseFloat(event.baseTicketExpense || 0);
                    const totalSpent = dailyTotal + ticketExpense;

                    return { totalSpent: totalSpent.toFixed(2) };
                });

                // --- ç²å–å–®å€‹è¡Œç¨‹çš„ç¸½èŠ±è²» (ç”¨æ–¼è¡Œç¨‹åˆ—è¡¨) ---
                const getEventTotalExpense = (event) => {
                    if (!event || !event.dailyItems) return '0.00';
                    // MODIFIED: Sum expenses from dailyItems/expenseAmount AND baseTicketExpense
                    const dailyTotal = event.dailyItems.reduce((sum, item) => sum + (item.expenseAmount || 0), 0);
                    const ticketExpense = parseFloat(event.baseTicketExpense || 0);
                    const totalSpent = dailyTotal + ticketExpense;
                    return totalSpent.toFixed(2);
                };

                
                // --- Firestore CRUD å‡½æ•¸ ---
                const getEventCollectionRef = () => {
                    const userDir = userId.value ? `/artifacts/${appId}/users/${userId.value}` : '';
                    return collection(db, `${userDir}/schedules`);
                };

                const getColorDocRef = () => {
                    const userDir = userId.value ? `/artifacts/${appId}/users/${userId.value}` : '';
                    return doc(db, `${userDir}/fan_colors/colors`);
                }

                const getThemeDocRef = () => {
                     const userDir = userId.value ? `/artifacts/${appId}/users/${userId.value}` : '';
                    return doc(db, `${userDir}/app_theme/theme`);
                }
                
                const subscribeToEvents = () => {
                    if (unsubscribeEvents) unsubscribeEvents();
                    if (unsubscribeColors) unsubscribeColors();
                    if (unsubscribeTheme) unsubscribeTheme();
                    if (!userId.value) return;

                    const eventsRef = getEventCollectionRef();
                    unsubscribeEvents = onSnapshot(eventsRef, (snapshot) => {
                        const fetchedEvents = [];
                        snapshot.forEach((doc) => fetchedEvents.push({ id: doc.id, ...doc.data() }));
                        events.value = fetchedEvents;
                        loading.value = false;
                        if (currentEvent.value && currentEvent.value.participants.length > 0) {
                             // Removed: newExpense.value.participants logic
                        }
                    }, (error) => { console.error("Error fetching events:", error); loading.value = false; });

                    const colorsRef = getColorDocRef();
                    unsubscribeColors = onSnapshot(colorsRef, (doc) => {
                        fanColors.value = doc.data() || {};
                    }, (error) => { console.error("Error fetching fan colors:", error); });
                    
                    // NEW: Subscribe to Theme
                    const themeRef = getThemeDocRef();
                    unsubscribeTheme = onSnapshot(themeRef, (doc) => {
                        const data = doc.data();
                        const hexColor = data ? (data.hex || INITIAL_APP_THEME_HEX) : INITIAL_APP_THEME_HEX;
                        applyTheme(hexColor);
                        newThemeSelectionHex.value = hexColor;
                    }, (error) => { console.error("Error fetching app theme:", error); });
                };
                
                const handleAuth = async () => {
                    try {
                        app = initializeApp(firebaseConfig);
                        db = getFirestore(app);
                        auth = getAuth(app);
                        if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                        else await signInAnonymously(auth);
                        onAuthStateChanged(auth, (user) => {
                            if (user) { userId.value = user.uid; isAuthReady.value = true; subscribeToEvents(); } 
                            else { console.log("User signed out or failed to sign in."); userId.value = null; isAuthReady.value = true; loading.value = false; }
                        });
                    } catch (error) { console.error("Firebase Initialization/Auth Error:", error); isAuthReady.value = true; loading.value = false; }
                };

                // NEW: é¡è‰²ç®¡ç† CRUD
                const addOrUpdateColor = async () => {
                    if (!newColorArtist.value || !newColorClass.value) return;
                    const artist = newColorArtist.value.trim();
                    const color = newColorClass.value.trim().toUpperCase();

                    // Validation for HEX
                    if (!/^#([0-9A-F]{3}){1,2}$/.test(color)) {
                        alert('æ‡‰æ´è‰²å¿…é ˆæ˜¯æœ‰æ•ˆçš„ HEX è‰²ç¢¼ (ä¾‹å¦‚: #FF4B91)');
                        return;
                    }

                    try {
                        await setDoc(getColorDocRef(), {
                            [artist]: color
                        }, { merge: true });
                        newColorArtist.value = '';
                        newColorClass.value = '#EF4444';
                    } catch (e) {
                        console.error("Error saving color:", e);
                    }
                };

                const deleteColor = async (artist) => {
                    try {
                        const updatedColors = { ...fanColors.value };
                        delete updatedColors[artist];
                        await setDoc(getColorDocRef(), updatedColors, { merge: false });
                    } catch (e) {
                        console.error("Error deleting color:", e);
                    }
                };

                // NEW: ä¸»é¡Œè¨­å®š CRUD
                const saveAppTheme = async () => {
                    const hex = newThemeSelectionHex.value.toUpperCase();
                    if (!/^#([0-9A-F]{3}){1,2}$/.test(hex)) {
                        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ HEX è‰²ç¢¼ (ä¾‹å¦‚: #FF4B91)');
                        return;
                    }
                    try {
                        await setDoc(getThemeDocRef(), { hex: hex }, { merge: true });
                        applyTheme(hex); 
                        showColorModal.value = false;
                    } catch (e) {
                        console.error("Error saving app theme:", e);
                    }
                };

                const convertYYMMDDToYYYYMMDD = (yyMMDD) => {
                    if (yyMMDD.length !== 6) return '';
                    const yy = yyMMDD.substring(0, 2); const mm = yyMMDD.substring(2, 4); const dd = yyMMDD.substring(4, 6);
                    const year = '20' + yy; return `${year}-${mm}-${dd}`;
                };
                
                const handleFileSelect = (event) => {
                    const files = event.target.files;
                    if (files.length > 0) selectedFile.value = files[0]; else selectedFile.value = null;
                };
                
                const importCSV = () => {
                    if (!selectedFile.value || isImporting.value) return; isImporting.value = true; const reader = new FileReader();

                    reader.onload = async (e) => {
                        const csvText = e.target.result; const lines = csvText.trim().split('\n');
                        if (lines.length < 2) { console.error('éŒ¯èª¤ï¼šCSVæª”æ¡ˆå…§å®¹ä¸è¶³ã€‚'); isImporting.value = false; return; }
                        const header = lines[0].trim().split(','); const dataLines = lines.slice(1); let importedCount = 0; let errorCount = 0;
                        const dateIndex = header.indexOf('æ—¥æœŸ'); const artistIndex = header.indexOf('æ­Œæ‰‹'); const eventNameIndex = header.indexOf('æ´»å‹•åç¨±'); const locationIndex = header.indexOf('åœ°é»');
                        if (dateIndex === -1 || artistIndex === -1 || eventNameIndex === -1 || locationIndex === -1) { console.error('éŒ¯èª¤ï¼šCSVæ¨™é¡Œä¸ç¬¦åˆé æœŸ (éœ€åŒ…å«ï¼šæ—¥æœŸ,æ­Œæ‰‹,æ´»å‹•åç¨±,åœ°é»)ã€‚'); isImporting.value = false; return; }
                        for (const line of dataLines) {
                            if (!line.trim()) continue;
                            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim()); 
                            if (values.length > Math.max(dateIndex, artistIndex, eventNameIndex, locationIndex)) {
                                let rawDate = values[dateIndex].replace(/"/g, '').trim(); let date = convertYYMMDDToYYYYMMDD(rawDate); let eventDate = new Date(date);
                                if (!date || isNaN(eventDate)) { errorCount++; console.warn(`Skipping line due to invalid date: ${line}`); continue; }
                                let eventName = values[eventNameIndex].trim().replace(/^"|"$/g, '').replace(/""/g, '"'); let artistName = values[artistIndex].trim().replace(/"/g, '').trim(); let mainLocation = values[locationIndex].trim().replace(/"/g, '').trim();
                                const newEvent = { eventName: eventName || 'ç„¡æ´»å‹•åç¨±', artistName: artistName || 'ç„¡æ­Œæ‰‹', year: eventDate.getFullYear(), date: date, mainLocation: mainLocation || 'æœªè¨­å®šåœ°é»', dailyItems: [], baseTicketExpense: 0, participants: ['æˆ‘'] };
                                try { await addDoc(getEventCollectionRef(), newEvent); importedCount++; } catch (e) { console.error("Error adding document during import: ", e); errorCount++; }
                            } else { errorCount++; console.warn(`Skipping line due to insufficient fields: ${line}`); }
                        }
                        isImporting.value = false; selectedFile.value = null; document.getElementById('csvFile').value = ''; showImportModal.value = false;
                        console.log(`åŒ¯å…¥å®Œæˆï¼æˆåŠŸåŒ¯å…¥ ${importedCount} å€‹è¡Œç¨‹ã€‚ (æœ‰ ${errorCount} å€‹è¡Œç¨‹å› æ ¼å¼éŒ¯èª¤è€Œè¢«è·³é)`);
                    };
                    reader.onerror = () => { isImporting.value = false; console.error('æª”æ¡ˆè®€å–å¤±æ•—ã€‚'); };
                    reader.readAsText(selectedFile.value, 'UTF-8');
                };

                const addEvent = async () => {
                    if (!newEventName.value || !newArtistName.value || !newEventDate.value) return; 
                    if (!userId.value) { console.error("Authentication not ready."); return; }
                    const eventDate = new Date(newEventDate.value); const eventYear = eventDate.getFullYear();
                    // Initialize with 0 for baseTicketExpense
                    const newEvent = { eventName: newEventName.value, artistName: newArtistName.value, year: eventYear, date: newEventDate.value, mainLocation: newEventLocation.value, dailyItems: [], baseTicketExpense: 0, participants: ['æˆ‘'] };
                    try {
                        const docRef = await addDoc(getEventCollectionRef(), newEvent); activeEventId.value = docRef.id; showEventModal.value = false;
                        newEventName.value = ''; newArtistName.value = ''; newEventDate.value = ''; newEventLocation.value = '';
                    } catch (e) { console.error("Error adding document: ", e); }
                };

                const deleteEvent = async (id) => {
                    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚')) { 
                        try { await deleteDoc(doc(getEventCollectionRef(), id)); if (activeEventId.value === id) activeEventId.value = null; } 
                        catch (e) { console.error("Error deleting document: ", e); }
                    }
                };
                
                const updateEvent = async (updatedData) => {
                    if (!currentEvent.value) return;
                    try { const eventRef = doc(getEventCollectionRef(), activeEventId.value); await setDoc(eventRef, updatedData, { merge: true }); } 
                    catch (e) { console.error("Error updating document: ", e); }
                };

                const loadEditForm = () => {
                    if (!currentEvent.value) return;
                    editEventForm.value = {
                        eventName: currentEvent.value.eventName,
                        artistName: currentEvent.value.artistName,
                        date: currentEvent.value.date,
                        mainLocation: currentEvent.value.mainLocation,
                        baseTicketExpense: parseFloat(currentEvent.value.baseTicketExpense || 0), // LOAD NEW FIELD
                        id: currentEvent.value.id
                    };
                    showEditModal.value = true;
                };

                const saveEditedEvent = async () => {
                    if (!editEventForm.value.eventName || !editEventForm.value.artistName || !editEventForm.value.date || !editEventForm.value.id) return;
                    const newDate = editEventForm.value.date; const newYear = new Date(newDate).getFullYear();
                    const updatedData = { 
                        eventName: editEventForm.value.eventName, 
                        artistName: editEventForm.value.artistName, 
                        date: newDate, 
                        year: newYear, 
                        mainLocation: editEventForm.value.mainLocation,
                        baseTicketExpense: parseFloat(editEventForm.value.baseTicketExpense) || 0 // SAVE NEW FIELD
                    };
                    try { await updateDoc(doc(getEventCollectionRef(), editEventForm.value.id), updatedData); showEditModal.value = false; } 
                    catch (e) { console.error("Error saving edited document: ", e); }
                };

                const addParticipant = async () => {
                    const name = newParticipant.value.trim();
                    if (!currentEvent.value || !name || currentEvent.value.participants.includes(name) || name === '') return;
                    const updatedParticipants = [...currentEvent.value.participants, name];
                    await updateEvent({ participants: updatedParticipants }); newParticipant.value = '';
                };

                const removeParticipant = async (name) => {
                    if (!currentEvent.value || name === 'æˆ‘') return; 
                    if (confirm(`ç¢ºå®šè¦å°‡ ${name} å¾åƒèˆ‡è€…åå–®ä¸­ç§»é™¤å—? ç§»é™¤å¾Œï¼Œä»–çš„æ‰€æœ‰æ”¯å‡º/åˆ†æ”¤è¨˜éŒ„å°‡æœƒè¢«æ›´æ–°ã€‚`)) {
                        const updatedParticipants = currentEvent.value.participants.filter(p => p !== name);
                        const updatedExpenses = currentEvent.value.expenses.map(exp => ({ ...exp, payer: exp.payer === name ? 'æˆ‘' : exp.payer, participants: exp.participants.filter(p => p !== name) }));
                        await updateEvent({ participants: updatedParticipants, expenses: updatedExpenses });
                    }
                };

                const addDailyItem = async () => {
                    if (!currentEvent.value || !newSchedule.value.location) return;
                    
                    const expenseAmount = parseFloat(newSchedule.value.expenseAmount) || 0;
                    const expenseDescription = newSchedule.value.expenseDescription || (expenseAmount > 0 ? 'æœªå‘½åæ”¯å‡º' : '');

                    const updatedItems = [...currentEvent.value.dailyItems, { 
                        time: newSchedule.value.time, 
                        location: newSchedule.value.location, 
                        description: newSchedule.value.description,
                        expenseAmount: expenseAmount, 
                        expenseDescription: expenseDescription, 
                        id: crypto.randomUUID() 
                    }];
                    await updateEvent({ dailyItems: updatedItems }); 
                    
                    newSchedule.value = { 
                        time: '09:00', 
                        location: '', 
                        description: '', 
                        expenseAmount: 0, 
                        expenseDescription: '' 
                    };
                };

                const deleteDailyItem = async (itemId) => {
                    if (!currentEvent.value) return;
                    const updatedItems = currentEvent.value.dailyItems.filter(item => item.id !== itemId);
                    await updateEvent({ dailyItems: updatedItems });
                };

                const addExpense = async () => {
                    alert('æ­¤æŒ‰éˆ•å·²è¢«ç§»é™¤ã€‚è«‹é€éã€Œæ–°å¢æ¯æ—¥è¡Œç¨‹é …ç›®ã€ä¾†è¨˜éŒ„æ”¯å‡ºã€‚');
                };

                const deleteExpense = async (expenseId) => {
                    if (!currentEvent.value) return;
                    const updatedExpenses = currentEvent.value.expenses.filter(item => item.id !== expenseId);
                    await updateEvent({ expenses: updatedExpenses });
                };

                handleAuth();

                return {
                    loading, isAuthReady, events, activeEventId, activeTab, 
                    newEventName, newArtistName, showEventModal, showEditModal, editEventForm, 
                    newEventDate, newEventLocation, newSchedule, newExpense, selectedReviewYear, 
                    showExclusionDisclaimer, selectedFile, isImporting, showImportModal, handleFileSelect,
                    importCSV, newParticipant, currentEvent, eventYears, eventsInSelectedScope, 
                    overallStats, mapLink, expenseSummary, upcomingEvents, pastEvents, getEventTotalExpense, 
                    getFanColorClass, 
                    
                    // Color Management
                    fanColors,
                    showColorModal,
                    newColorArtist,
                    newColorClass,
                    addOrUpdateColor,
                    deleteColor,

                    // Theme Management
                    currentAppThemeHex,
                    newThemeSelectionHex,
                    saveAppTheme,
                    
                    showDailyItemModal,
                    showEntrySelectionModal, 

                    setActiveEvent: (id) => { activeEventId.value = id; activeTab.value = 'info'; },
                    setActiveTab: (tab) => activeTab.value = tab,
                    goToEventList: () => { activeEventId.value = null; activeTab.value = 'schedule'; }, 
                    addEvent, deleteEvent, loadEditForm, saveEditedEvent, addParticipant, removeParticipant,
                    addDailyItem, deleteDailyItem, addExpense, deleteExpense,
                };
            }
        };

        // Custom Tailwind Configuration (Uses CSS variables for main theme, standard colors foræ‡‰æ´è‰²)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Dynamically inject theme base using CSS variables
                        'app-theme': {
                            50: 'rgba(var(--theme-rgb), 0.05)',
                            100: 'rgba(var(--theme-rgb), 0.1)',
                            400: 'rgba(var(--theme-rgb), 0.6)', // Used for borders, lighter elements
                            500: 'rgba(var(--theme-rgb), 0.8)', // Main buttons/nav color
                            600: 'rgba(var(--theme-rgb), 0.9)',
                            700: 'var(--theme-hex)', // Used for text, primary color
                            800: 'var(--theme-hex)', // Used for text, darker color
                        },
                        // Standard colors for fan themes (NOTE: We rely on JIT binding for user-input colors)
                        'aquamarine': { 400: '#4FBDBA', 500: '#349996', 100: '#d9fffd', 700: '#235c59', 800: '#1b3d3c', 50: '#f0fffe' },
                        // Include a few common colors as fallbacks or for pre-defined classes
                        'red': { 500: '#EF4444' }, 
                        'blue': { 500: '#3B82F6' },
                        'gray': { 400: '#9CA3AF' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }

        // Mount the Vue app
        window.onload = () => {
            createApp(EventTracker).mount('#app');
        };
    </script>
    <style>
        /* Fallback default theme color */
        :root {
            --theme-hex: #4FBDBA; 
            --theme-rgb: 79, 189, 186; 
        }
        /* Custom JIT style for dynamic hex colors */
        /* This generic pattern allows border-[#XXXXXX] to work */
        [class*="border-\[#"] {
            border-color: var(--tw-border-opacity, 1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

    <!-- ä¸» App å®¹å™¨ -->
    <div id="app" class="flex justify-center">
        <!-- æ¨¡æ“¬æ‰‹æ©Ÿ App ä»‹é¢ -->
        <div class="w-full max-w-md bg-white shadow-xl min-h-screen flex flex-col">

            <!-- é ‚éƒ¨æ¨™é¡Œåˆ— -->
            <header class="bg-app-theme-400 text-white p-4 shadow-lg sticky top-0 z-10">
                <div class="flex justify-between items-center">
                    <!-- NEW: è¿”å›ä¸»åˆ—è¡¨æŒ‰éˆ• -->
                    <button v-if="currentEvent" @click="goToEventList"
                            class="text-white p-1 rounded-full transition duration-150 transform hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <!-- TITLE -->
                    <h1 class="text-xl font-bold" :class="{'w-full text-center': !currentEvent}">
                        è¿½æ˜Ÿè¦åŠƒä¸­å¿ƒ
                    </h1>
                    <div class="flex space-x-2">
                        <!-- NEW: åˆä½µå¾Œçš„æ–°å¢/åŒ¯å…¥æŒ‰éˆ• -->
                        <button @click="showEntrySelectionModal = true"
                                class="bg-app-theme-500 hover:bg-app-theme-600 text-white p-2 rounded-full shadow transition duration-150 transform hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <!-- Delete Button (Only visible on specific event page) -->
                    <button v-if="currentEvent" @click="deleteEvent(currentEvent.id)"
                            class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow transition duration-150 transform hover:scale-105 absolute right-4 top-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                </div>

                <!-- ç•¶å‰è¡Œç¨‹/æ­Œæ‰‹è³‡è¨Š (åƒ…åœ¨é¸å®šæ´»å‹•æ™‚é¡¯ç¤º) -->
                <div v-if="currentEvent" class="mt-2 text-center">
                    <h2 class="text-2xl font-extrabold">{{ currentEvent.eventName }}</h2>
                    <p class="text-sm opacity-90">
                        {{ currentEvent.artistName }} ({{ currentEvent.year }})
                        <span v-if="currentEvent.date" class="block text-xs mt-1">
                            æ—¥æœŸ: {{ currentEvent.date }} | åœ°é»: {{ currentEvent.mainLocation || 'æœªè¨­å®š' }}
                        </span>
                    </p>
                </div>
            </header>

            <!-- å…§å®¹å€åŸŸ -->
            <main class="flex-grow p-4 overflow-y-auto">
                <!-- åŠ è¼‰ç‹€æ…‹ -->
                <div v-if="loading || !isAuthReady" class="text-center p-8 text-gray-500">
                    <p>æ­£åœ¨åŠªåŠ›é€£æ¥ Firebase... è«‹ç¨å€™</p>
                    <div class="mt-4 animate-spin rounded-full h-8 w-8 border-b-2 border-app-theme-500"></div>
                </div>

                <!-- NEW CONTENT STRUCTURE -->
                <div v-else>
                    
                    <!-- 1. Review Tab (å›é¡§ - Global Content) -->
                    <div v-if="activeTab === 'review'">
                        <h2 class="text-xl font-semibold text-app-theme-700">âœ¨ è¿½æ˜Ÿå¹´å ±ï¼šå¹´åº¦é–ƒè€€æ™‚åˆ»å›é¡§ âœ¨</h2>

                        <!-- NEW: å¹´åº¦é¸æ“‡å™¨ -->
                        <div class="mb-4 flex items-center space-x-2">
                            <label for="year-select" class="text-sm font-medium text-gray-700">é¸æ“‡å¹´åº¦:</label>
                            <select id="year-select" v-model="selectedReviewYear"
                                    class="p-2 border border-app-theme-300 focus:ring-app-theme-400 rounded-lg text-sm bg-white">
                                <option value="all">ç¸½å¹´åº¦</option>
                                <option v-for="year in eventYears" :key="year" :value="year">{{ year }} å¹´</option>
                            </select>
                        </div>

                        <!-- NEW: æ‡‰æ´è³‡é‡‘ç¸½å›é¡§ -->
                        <div class="p-4 rounded-xl shadow-lg mb-6 border-l-4 bg-app-theme-100 border-app-theme-500">
                            <h3 class="text-xl font-bold text-app-theme-800">
                                <span class="text-3xl mr-2">ğŸ’°</span> æ‡‰æ´å¶åƒèŠ±äº† ğŸ’¸
                            </h3>
                            <p class="text-base text-gray-700 mb-4 border-b border-app-theme-200 pb-2">
                                ç¸½è¨ˆèŠ±è²» (NTD)ï¼š<span class="text-2xl font-extrabold text-red-600">NT$ {{ overallStats.totalExpense }}</span>
                                <br>
                                å¹³å‡æ¯å ´æ´»å‹•èŠ±è²»ï¼š<span class="text-xl font-extrabold text-app-theme-600">NT$ {{ overallStats.avgExpensePerEvent }}</span>
                                <br>
                                <span class="text-xs text-gray-500">ï¼ˆåŸºæ–¼æ‰€æœ‰ {{ overallStats.totalEventsAll }} å ´æ´»å‹•ï¼‰</span>
                            </p>
                        </div>
                        <!-- END NEW: æ‡‰æ´è³‡é‡‘ç¸½å›é¡§ -->

                        <!-- Overall Stats Block (Enhanced) -->
                        <div class="p-4 rounded-xl shadow-lg mb-6 border-l-4 bg-app-theme-100 border-app-theme-500">
                            <h3 class="text-xl font-bold text-app-theme-800">
                                <span class="text-3xl mr-2">ğŸŒŸ</span> 
                                {{ selectedReviewYear === 'all' ? 'ç¸½é«”è¿½æ˜Ÿæˆå°±' : selectedReviewYear + ' å¹´åº¦è¿½æ˜Ÿæˆå°±' }} ğŸš€
                            </h3>
                            
                            <!-- Total Events (Unfiltered) -->
                            <p class="text-base text-gray-700 mb-4 border-b border-app-theme-200 pb-2">
                                ç¸½æ´»å‹•å ´æ¬¡ (å«æ‰€æœ‰)ï¼š<span class="text-2xl font-extrabold text-app-theme-600">{{ overallStats.totalEventsAll }}</span> å ´ï¼ <span class="text-xl">ğŸ™Œ</span>
                                <br>
                                ä¸»è¦æˆå°±æ´»å‹•å ´æ¬¡ï¼š<span class="text-xl font-extrabold text-app-theme-600">{{ overallStats.totalEventsFiltered }}</span> å ´
                                <br>
                                è§£é–äº† <span class="text-xl font-extrabold text-app-theme-600">{{ overallStats.uniqueArtists }}</span> ä½ä¸åŒçš„å¶åƒ/è—äººï¼ <span class="text-xl">ğŸ’–</span>
                            </p>
                            
                            <!-- NEW: å¯å±•é–‹çš„æ’é™¤æ´»å‹•æç¤º -->
                            <div class="mb-4">
                                <button @click="showExclusionDisclaimer = !showExclusionDisclaimer" 
                                        class="text-xs text-blue-600 hover:text-blue-800 transition underline focus:outline-none">
                                    {{ showExclusionDisclaimer ? 'â–² éš±è—æ’é™¤æ´»å‹•æç¤º' : 'â–¼ é—œæ–¼æ’é™¤çš„æ´»å‹•é¡å‹ (é»æ“ŠæŸ¥çœ‹)' }}
                                </button>
                                <p v-if="showExclusionDisclaimer" class="text-xs text-red-500 mt-2 p-2 border border-red-300 bg-red-50 rounded-lg">
                                    â€» **æ’è¡Œæ¦œ/é‡è¤‡å ´æ¬¡** çµ±è¨ˆå·²æ’é™¤æ´»å‹•åç¨±ä¸­åŒ…å«ï¼šã€Œì‚¬ì „ë…¹í™”ã€ã€ã€Œäº‹å‰éŒ„è£½ã€ã€ã€Œç°½å”®æœƒã€ã€ã€Œç°½åæœƒã€ã€ã€ŒéŒ„è£½ã€ç­‰éå·¡è¿´ä¸»é¡Œæ´»å‹•ï¼Œä»¥èšç„¦æ–¼å¤§å‹æ¼”å‡ºæˆå°±ã€‚
                                </p>
                            </div>
                            <!-- END NEW: å¯å±•é–‹çš„æ’é™¤æ´»å‹•æç¤º -->

                            <div v-if="overallStats.artistBreakdown.length > 0">
                                <h4 class="font-semibold text-app-theme-700 mt-2 flex items-center">ğŸ¥‡ å¿ èª åº¦æ’è¡Œæ¦œ (è¦‹äº†èª°æœ€å¤šæ¬¡)</h4>
                                <ul class="text-sm space-y-1 mt-1">
                                    <li v-for="(item, index) in overallStats.artistBreakdown.slice(0, 5)" :key="item.name" class="flex justify-between">
                                        <span class="font-medium">
                                            {{ index === 0 ? 'ğŸ‘‘' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'âœ¨' }} {{ item.name }}
                                        </span>
                                        <span class="font-bold text-app-theme-700">{{ item.count }} æ¬¡</span>
                                    </li>
                                </ul>
                            </div>

                            <div v-if="overallStats.eventRepetitionBreakdown.length > 0">
                                <h4 class="font-semibold text-app-theme-700 mt-4 border-t border-app-theme-200 pt-3 flex items-center">
                                    <span class="text-lg mr-1">ğŸ”¥</span> çœŸæ„›é‡è¤‡å ´ï¼šé€™äº›èˆå°ä½ çµ•å°æ˜¯VIPï¼ 
                                </h4>
                                <ul class="text-sm space-y-1 mt-1">
                                    <li v-for="(item, index) in overallStats.eventRepetitionBreakdown.slice(0, 3)" :key="item.name" class="flex justify-between">
                                        <span class="font-medium">
                                            <span v-if="index === 0">âœ¨ ç„¡æ³•æŠ—æ‹’çš„é­…åŠ›ï¼ã€Š{{ item.name }}ã€‹</span>
                                            <span v-else-if="index === 1">ğŸ’– å¤šåˆ·çš„åƒ¹å€¼ï¼ã€Š{{ item.name }}ã€‹</span>
                                            <span v-else-if="index === 2">ğŸ¶ å€¼å¾—å†çœ‹ä¸€éï¼ã€Š{{ item.name }}ã€‹</span>
                                            <span v-else>ğŸ” ã€Š{{ item.name }}ã€‹</span>
                                        </span>
                                        <span class="font-bold text-red-600">{{ item.count }} å ´</span> 
                                    </li>
                                </ul>
                            </div>
                            <p v-else class="text-xs text-gray-500 mt-4 border-t border-app-theme-200 pt-2">ğŸ‘ å¤ªæ£’äº†ï¼Œéƒ½æ˜¯å…¨æ–°é«”é©—ï¼</p>
                        </div>
                        <!-- END Overall Stats Block -->

                        <!-- NEW: å¹´åº¦è©³ç´°æ´»å‹•æ¸…å–® -->
                        <h3 class="text-xl font-semibold text-app-theme-700 mt-6 mb-3">
                            ğŸ“œ è©³ç´°æ´»å‹•æ¸…å–® ({{ selectedReviewYear === 'all' ? 'ç¸½å¹´åº¦' : selectedReviewYear + 'å¹´' }})
                        </h3>
                        <div v-if="eventsInSelectedScope.length > 0" class="space-y-2">
                             <div v-for="event in eventsInSelectedScope" :key="event.id"
                                 @click="setActiveEvent(event.id); setActiveTab('info')"
                                 class="p-3 bg-white hover:bg-gray-50 rounded-lg border-l-4"
                                 :class="event.date >= today ? getFanColorClass(event.artistName) : 'border-gray-400'">
                                <p class="font-bold text-gray-800">{{ event.eventName }} ({{ event.artistName }})</p>
                                <p class="text-sm text-gray-600 flex justify-between">
                                    <span>ğŸ“… {{ event.date }}</span>
                                </p>
                            </div>
                        </div>
                        <div v-else class="text-center p-4 text-gray-500 border border-dashed rounded-xl">
                            <p>æ­¤ç¯©é¸ç¯„åœå…§æ²’æœ‰æ‰¾åˆ°ä»»ä½•è¡Œç¨‹ç´€éŒ„ã€‚</p>
                        </div>
                        <!-- END NEW: å¹´åº¦è©³ç´°æ´»å‹•æ¸…å–® -->

                    </div>
                    
                    <!-- 2. Expense Tab (è¨˜å¸³ - Requires Event) -->
                    <div v-else-if="activeTab === 'expense'">
                        <h2 class="text-xl font-semibold text-app-theme-700">è¨˜å¸³</h2>
                        
                        <div v-if="!currentEvent" class="text-center p-8 bg-white rounded-xl shadow-md border border-red-300">
                            <p class="text-lg font-bold text-red-600 mb-2">ğŸ˜­ è«‹å…ˆé¸æ“‡ä¸€å€‹è¡Œç¨‹æ‰èƒ½è¨˜å¸³ï¼</p>
                            <p class="text-gray-500">é»æ“Šåº•ä¸‹çš„ã€Œè¡Œç¨‹ã€æ¨™ç±¤å›åˆ°åˆ—è¡¨é¸æ“‡ã€‚</p>
                        </div>
                        
                        <div v-else>
                            <!-- çµç®—çµæœ (SIMPLIFIED) -->
                            <div class="p-4 rounded-xl shadow-md mb-4 bg-app-theme-100">
                                <p class="font-bold text-app-theme-800">ç•¶å‰æ´»å‹•ç¸½èŠ±è²»: NT$ {{ expenseSummary.totalSpent }}</p>
                            </div>

                            <!-- ç¾æœ‰æ”¯å‡ºåˆ—è¡¨ -->
                            <div v-if="currentEvent.dailyItems && currentEvent.dailyItems.filter(item => item.expenseAmount > 0).length > 0" class="space-y-3 mb-6">
                                <h3 class="font-semibold text-gray-700 border-b pb-1">æ”¯å‡ºç´€éŒ„ (ä¾†è‡ªæ¯æ—¥è¡Œç¨‹é …ç›®)</h3>
                                <div v-for="item in currentEvent.dailyItems.filter(item => item.expenseAmount > 0)" :key="item.id"
                                    class="flex justify-between items-center p-3 bg-white border-l-4 border-app-theme-400">
                                    <div class="flex-grow">
                                        <p class="font-bold text-gray-800">{{ item.expenseDescription || item.description }}</p>
                                        <p class="text-sm text-red-600 font-semibold">NT$ {{ item.expenseAmount.toFixed(2) }}</p>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="text-center p-4 text-gray-500 border border-dashed rounded-xl mb-4">
                                <p>æ­¤æ´»å‹•å°šæœªæ–°å¢ä»»ä½•æ”¯å‡ºç´€éŒ„ã€‚</p>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Schedule/Info/Default Tab (è¡Œç¨‹ - åˆ—è¡¨æˆ–è©³ç´°) -->
                    <div v-else> 
                        
                        <!-- ç‹€æ…‹ 1: å·²é¸å®šç‰¹å®šè¡Œç¨‹ (é¡¯ç¤º info æˆ– schedule) -->
                        <div v-if="currentEvent">
                            <!-- è¡Œç¨‹è³‡è¨Šç¸½è¦½ (info) -->
                            <div v-if="activeTab === 'info'">
                                <h2 class="text-xl font-semibold text-app-theme-700">è¡Œç¨‹ç¸½è¦½èˆ‡ç¢ºèª</h2>

                                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-app-theme-400 space-y-4">
                                    <!-- UPDATED: Date and Location emphasized -->
                                    <div class="text-center space-y-2">
                                        <p class="text-5xl font-extrabold text-app-theme-800">{{ currentEvent.date }}</p>
                                        <p class="text-xl font-bold text-gray-800">{{ currentEvent.mainLocation || 'æœªè¨­å®š' }}</p>
                                    </div>
                                    <!-- END UPDATED -->

                                    <hr class="border-gray-200">
                                    
                                    <!-- NEW: ç·¨è¼¯æŒ‰éˆ• -->
                                    <button @click="loadEditForm"
                                            class="w-full bg-gray-200 text-gray-700 font-bold py-2 rounded-lg hover:bg-gray-300 transition flex items-center justify-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-1.414 7.071a1 1 0 00-.293.707v3h3a1 1 0 00.707-.293l3.182-3.182a4 4 0 00-5.656-5.656l-3.293 3.293a1 1 0 00-.293.707V15h3a1 1 0 00.707-.293l4.5-4.5z" />
                                        </svg>
                                        <span>ç·¨è¼¯è¡Œç¨‹åŸºæœ¬è³‡æ–™</span>
                                    </button>
                                    <!-- END NEW: ç·¨è¼¯æŒ‰éˆ• -->

                                    <p class="text-lg font-bold text-gray-800">æ´»å‹•åç¨±: {{ currentEvent.eventName }}</p>
                                    <p class="text-md text-gray-700">æ­Œæ‰‹/å¶åƒ: <span class="font-medium text-app-theme-800">{{ currentEvent.artistName }}</span></p>
                                    <p class="text-md text-gray-700">å¹´åº¦å›é¡§: <span class="font-medium text-app-theme-800">{{ currentEvent.year }} å¹´</span></p>
                                    <p class="text-md text-gray-700">åŒè¡Œå¤¥ä¼´: <span class="font-medium text-app-theme-800">{{ currentEvent.participants ? currentEvent.participants.join(', ') : 'ç„¡' }}</span></p>
                                    
                                    <!-- Show Total Expense on Info Page -->
                                    <p class="text-md font-bold text-gray-700 border-t pt-2 border-gray-200">ç•¶å‰æ´»å‹•èŠ±è²»: <span class="text-red-600">NT$ {{ getEventTotalExpense(currentEvent) }}</span></p>

                                    <div class="pt-4 border-t border-gray-200">
                                        <button @click="setActiveTab('schedule')"
                                                class="bg-app-theme-500 hover:bg-app-theme-600 w-full text-white font-bold py-3 rounded-lg transition shadow-lg transform hover:scale-[1.01]">
                                            ç¢ºèªç„¡èª¤ï¼ŒæŸ¥çœ‹æ¯æ—¥è©³ç´°è¡Œç¨‹ â†’
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ¯æ—¥è¡Œç¨‹è¡¨ (schedule) -->
                            <div v-else-if="activeTab === 'schedule'">
                                <h2 class="text-xl font-semibold text-app-theme-700">æ¯æ—¥è¡Œç¨‹è¡¨</h2>

                                <!-- åœ°åœ–/å°èˆªé€£çµ (UPDATED) -->
                                <a v-if="mapLink" :href="mapLink.url" target="_blank"
                                class="flex items-center justify-center p-3 rounded-xl shadow-sm transition mb-4 bg-app-theme-100 text-app-theme-700 hover:bg-app-theme-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                    </svg>
                                    æŸ¥çœ‹åœ°åœ–èˆ‡å°èˆª (åœ°é»ä¾†æº: {{ mapLink.source }})
                                </a>
                                <div v-else class="text-center p-3 text-gray-500 bg-gray-100 rounded-xl mb-4">
                                    è«‹å…ˆæ–°å¢æ¯æ—¥è¡Œç¨‹æˆ–è¨­å®šä¸»è¦åœ°é»ä»¥å•Ÿç”¨åœ°åœ–åŠŸèƒ½ã€‚
                                </div>
                                <!-- End Map Link (UPDATED) -->

                                <!-- ç¾æœ‰è¡Œç¨‹åˆ—è¡¨ -->
                                <div v-if="currentEvent.dailyItems && currentEvent.dailyItems.length > 0" class="space-y-3">
                                    <div v-for="item in currentEvent.dailyItems" :key="item.id"
                                        class="flex justify-between items-center p-3 bg-white border-l-4 border-app-theme-400">
                                        <div>
                                            <p class="font-bold text-gray-800">{{ item.time }} - {{ item.location }}</p>
                                            <p class="text-sm text-gray-500">{{ item.description }}</p>
                                            <!-- NEW: Show expense if present -->
                                            <p v-if="item.expenseAmount > 0" class="text-xs text-red-500">
                                                ğŸ’° æ”¯å‡º: {{ item.expenseDescription }} (NT$ {{ item.expenseAmount.toFixed(2) }})
                                            </p>
                                        </div>
                                        <button @click="deleteDailyItem(item.id)"
                                                class="text-red-500 hover:text-red-700 p-1 rounded-full transition">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div v-else class="text-center p-4 text-gray-500 border border-dashed rounded-xl mb-4">
                                    <p>æ­¤è¡Œç¨‹å°šæœªæ–°å¢ä»»ä½•æ¯æ—¥ç´°ç¯€ã€‚</p>
                                </div>

                                <!-- æ–°å¢è¡Œç¨‹è¡¨å–® (MODAL TRIGGER) -->
                                <button @click="showDailyItemModal = true"
                                        class="bg-app-theme-500 hover:bg-app-theme-600 w-full text-white font-bold py-2 rounded-lg transition mt-6">
                                    + æ–°å¢æ¯æ—¥è¡Œç¨‹é …ç›® (å«è¨˜å¸³)
                                </button>
                            </div>
                            <!-- Fallthrough: If activeTab is review or expense when currentEvent is true, 
                                it will fall into the main v-else-if blocks above (review/expense) which is desired. -->

                        </div>

                        <!-- ç‹€æ…‹ 2: æœªé¸å®šè¡Œç¨‹ (é¡¯ç¤ºæ´»å‹•åˆ—è¡¨) -->
                        <div v-else class="space-y-6">
                            <h2 class="text-xl font-semibold text-app-theme-700">æ‰€æœ‰è¿½æ˜Ÿè¡Œç¨‹</h2>

                            <!-- å¾…é€²è¡Œç¨‹ (Upcoming Events) -->
                            <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-app-theme-400">
                                <h3 class="text-lg font-bold text-app-theme-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L14 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 110-6 3 3 0 010 6z" />
                                    </svg>
                                    å³å°‡é€²è¡Œ
                                </h3>
                                <div v-if="upcomingEvents.length > 0" class="space-y-3">
                                    <div v-for="event in upcomingEvents" :key="event.id"
                                        @click="setActiveEvent(event.id)"
                                        class="p-3 bg-app-theme-50 hover:bg-app-theme-100 rounded-lg border-l-4"
                                        :class="getFanColorClass(event.artistName)">
                                        <p class="font-bold text-gray-800">{{ event.eventName }}</p>
                                        <p class="text-sm text-gray-600">{{ event.artistName }} - {{ event.date }}</p>
                                    </div>
                                </div>
                                <div v-else class="text-center p-3 text-red-500 font-semibold text-sm border border-red-300 rounded-lg bg-red-50">
                                    å¤©å•Šä½ æ²’æœ‰æ¼”å”±æœƒå¯ä»¥çœ‹äº†ï¼Œå¿«å»è²·é–€ç¥¨å§ï¼
                                </div>
                            </div>

                            <!-- éå»è¡Œç¨‹ (Past Events) -->
                            <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-gray-400">
                                <h3 class="text-lg font-bold text-gray-600 mb-3 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                                    </svg>
                                    ç¾å¥½å›æ†¶
                                </h3>
                                <div v-if="pastEvents.length > 0" class="space-y-3">
                                    <div v-for="event in pastEvents" :key="event.id"
                                        @click="setActiveEvent(event.id)"
                                        class="p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border-l-4"
                                        :class="getFanColorClass(event.artistName)">
                                        <p class="font-bold text-gray-700">{{ event.eventName }}</p>
                                        <p class="text-sm text-gray-500">{{ event.artistName }} - {{ event.date }}</p>
                                    </div>
                                </div>
                                <div v-else class="text-center p-3 text-gray-500 text-sm">
                                    ç›®å‰é‚„æ²’æœ‰ä»»ä½•ç´€éŒ„ã€‚
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- END NEW CONTENT STRUCTURE -->
            </main>

            <!-- åº•éƒ¨å°èˆªåˆ— -->
            <nav class="bg-white border-t border-gray-200 sticky bottom-0 z-10 shadow-t-lg">
                <div class="flex justify-around">
                    <!-- 1. è¡Œç¨‹/è¨˜å¸³ (Schedule/Info/Expense) -->
                    <button @click="goToEventList()"
                            class="flex flex-col items-center p-3 w-1/3 transition"
                            :class="activeTab !== 'review' && !showColorModal ? `text-app-theme-500 border-t-2 border-app-theme-500` : 'text-gray-500'">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                        </svg>
                        <span class="text-xs mt-1">è¡Œç¨‹/è¨˜å¸³</span>
                    </button>
                    <!-- 2. å›é¡§ (Review) -->
                    <button @click="setActiveTab('review')"
                            class="flex flex-col items-center p-3 w-1/3 transition"
                            :class="activeTab === 'review' ? `text-app-theme-500 border-t-2 border-app-theme-500` : 'text-gray-500'">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 6a1 1 0 011-1h10a1 1 0 011 1v10a1 1 0 01-1 1H5a1 1 0 01-1-1V6z" />
                        </svg>
                        <span class="text-xs mt-1">å›é¡§</span>
                    </button>
                    <!-- 3. è¨­å®š (Settings) -->
                    <button @click="showColorModal = true"
                            class="flex flex-col items-center p-3 w-1/3 transition"
                            :class="showColorModal ? `text-app-theme-500 border-t-2 border-app-theme-500` : 'text-gray-500'">
                        <!-- Settings Icon (Gear) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1-2 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1-2 2H2a2 2 0 0 0-2 2v.44a2 2 0 0 1 2 2h.44a2 2 0 0 0 2 2v.44a2 2 0 0 1 2 2h.44a2 2 0 0 0 2 2v.44a2 2 0 0 1 2 2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 1 2-2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 1 2-2h.44a2 2 0 002-2v-.44a2 2 0 0 1-2-2h-.44a2 2 0 00-2-2v-.44a2 2 0 0 1-2-2h-.44a2 2 0 00-2-2z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        <span class="text-xs mt-1">è¨­å®š</span>
                    </button>
                </div>
            </nav>

            <!-- Modal for New Event (å–®ç¨æ–°å¢) -->
            <div v-if="showEventModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-20">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                    <h2 class="text-xl font-bold text-app-theme-700">æ–°å¢è¿½æ˜Ÿè¡Œç¨‹</h2>
                    <div class="space-y-4">
                        <input type="text" v-model="newEventName" placeholder="æ´»å‹•åç¨± (å¦‚ï¼šXX æ¼”å”±æœƒ)"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-app-theme-400 focus:border-app-theme-400">
                        <input type="text" v-model="newArtistName" placeholder="æ­Œæ‰‹/æ˜æ˜Ÿæ˜¯èª° (å¦‚ï¼šå‘¨æ°å€«)"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-app-theme-400 focus:border-app-theme-400">
                        
                        <!-- æ–°å¢ï¼šæ´»å‹•æ—¥æœŸ -->
                        <label for="eventDate" class="block text-sm font-medium text-gray-700 pt-2">æ´»å‹•æ—¥æœŸ (å¿…å¡«):</label>
                        <input type="date" id="eventDate" v-model="newEventDate" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-app-theme-400 focus:border-app-theme-400">

                        <!-- æ–°å¢ï¼šä¸»è¦åœ°é» -->
                        <input type="text" v-model="newEventLocation" placeholder="ä¸»è¦åœ°é» (å¦‚ï¼šå°åŒ—å°å·¨è›‹)"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-app-theme-400 focus:border-app-theme-400">

                        <button @click="addEvent"
                                :disabled="!newEventName || !newArtistName || !newEventDate"
                                class="bg-app-theme-500 hover:bg-app-theme-600 w-full text-white font-bold py-3 rounded-lg transition disabled:bg-gray-400">
                            ç¢ºå®šæ–°å¢
                        </button>
                        <button @click="showEventModal = false"
                                class="w-full text-gray-600 font-medium py-2 rounded-lg hover:text-red-500 transition">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal for CSV Import (æ‰¹æ¬¡åŒ¯å…¥) -->
            <div v-if="showImportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-20">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                    <h2 class="text-xl font-bold text-app-theme-700">æ‰¹æ¬¡åŒ¯å…¥è¡Œç¨‹ (CSV)</h2>
                    <div class="space-y-4">
                        <input type="file" @change="handleFileSelect" accept=".csv"
                               class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-aquamarine-100 file:text-aquamarine-700 hover:file:bg-aquamarine-200"
                               id="csvFile" :disabled="isImporting">
                        
                        <p class="text-xs text-gray-500 border-t border-dashed pt-2">æ”¯æ´æ¬„ä½: **æ—¥æœŸ**, **æ­Œæ‰‹**, **æ´»å‹•åç¨±**, **åœ°é»** (æ—¥æœŸéœ€ç‚º YYMMDD æ ¼å¼)</p>

                        <button @click="importCSV" :disabled="!selectedFile || isImporting"
                                class="bg-app-theme-500 hover:bg-app-theme-600 w-full text-white font-bold py-3 rounded-lg transition disabled:bg-gray-400 flex items-center justify-center">
                            <span v-if="isImporting">
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                                æ­£åœ¨åŒ¯å…¥ä¸­...
                            </span>
                            <span v-else>
                                ç¢ºå®šåŒ¯å…¥ {{ selectedFile ? selectedFile.name : 'è«‹å…ˆé¸æ“‡ CSV æª”æ¡ˆ' }}
                            </span>
                        </button>
                        <button @click="showImportModal = false"
                                class="w-full text-gray-600 font-medium py-2 rounded-lg hover:text-red-500 transition">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- NEW: Modal for Entry Selection (é¸æ“‡æ–°å¢/åŒ¯å…¥æ–¹å¼) -->
            <div v-if="showEntrySelectionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-20">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                    <h2 class="text-xl font-bold text-app-theme-700 mb-4">é¸æ“‡è¡Œç¨‹å»ºç«‹æ–¹å¼</h2>
                    <div class="space-y-4">
                        <button @click="showEntrySelectionModal = false; showEventModal = true;"
                                class="w-full bg-app-theme-500 hover:bg-app-theme-600 text-white font-bold py-3 rounded-lg transition">
                            ğŸ“ å–®ç¨æ–°å¢è¡Œç¨‹
                        </button>
                        <button @click="showEntrySelectionModal = false; showImportModal = true;"
                                class="w-full bg-gray-200 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-300 transition">
                            ğŸ“ æ‰¹æ¬¡åŒ¯å…¥è¡Œç¨‹ (CSV)
                        </button>
                        <button @click="showEntrySelectionModal = false"
                                class="w-full text-gray-600 font-medium py-2 rounded-lg hover:text-red-500 transition">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
            <!-- END NEW: Modal for Entry Selection -->

            <!-- Modal for Edit Event (ç·¨è¼¯è¡Œç¨‹åŸºæœ¬è³‡æ–™) -->
            <div v-if="showEditModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-20">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                    <h2 class="text-xl font-bold text-app-theme-700">ç·¨è¼¯è¡Œç¨‹è³‡æ–™</h2>
                    <div class="space-y-4">
                        <input type="text" v-model="editEventForm.eventName" placeholder="æ´»å‹•åç¨±"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-app-theme-400 focus:border-app-theme-400">
                        <input type="text" v-model="editEventForm.artistName" placeholder="æ­Œæ‰‹/æ˜æ˜Ÿ"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-app-theme-400 focus:border-app-theme-400">
                        
                        <label for="editEventDate" class="block text-sm font-medium text-gray-700 pt-2">æ´»å‹•æ—¥æœŸ (å¿…å¡«):</label>
                        <input type="date" id="editEventDate" v-model="editEventForm.date" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-app-theme-400 focus:border-app-theme-400">

                        <input type="text" v-model="editEventForm.mainLocation" placeholder="ä¸»è¦åœ°é»"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-app-theme-400 focus:border-app-theme-400">
                        
                        <!-- NEW: é–€ç¥¨èŠ±è²»æ¬„ä½ -->
                        <label for="editTicketExpense" class="block text-sm font-medium text-gray-700 pt-2 border-t mt-4">é–€ç¥¨èŠ±è²» (NT$):</label>
                        <input type="number" id="editTicketExpense" v-model.number="editEventForm.baseTicketExpense" placeholder="é–€ç¥¨é‡‘é¡"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-app-theme-400 focus:border-app-theme-400">


                        <button @click="saveEditedEvent"
                                :disabled="!editEventForm.eventName || !editEventForm.artistName || !editEventForm.date"
                                class="bg-app-theme-500 hover:bg-app-theme-600 w-full text-white font-bold py-3 rounded-lg transition disabled:bg-gray-400">
                            å„²å­˜è®Šæ›´
                        </button>
                        <button @click="showEditModal = false"
                                class="w-full text-gray-600 font-medium py-2 rounded-lg hover:text-red-500 transition">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
            <!-- END Modal for Edit Event -->

            <!-- Modal for New Daily Item (æ–°å¢æ¯æ—¥è¡Œç¨‹é …ç›®) - ADDED -->
            <div v-if="showDailyItemModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-20">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                    <h3 class="font-bold text-app-theme-800">æ–°å¢æ¯æ—¥é …ç›® (å«è¨˜å¸³)</h3>
                    <div class="space-y-3">
                        <input type="time" v-model="newSchedule.time"
                               class="w-full p-2 border border-gray-300 rounded-lg focus:ring-app-theme-400 focus:border-app-theme-400">
                        <input type="text" v-model="newSchedule.location" placeholder="åœ°é» (å¦‚ï¼šå°åŒ—å°å·¨è›‹)"
                               class="w-full p-2 border border-gray-300 rounded-lg focus:ring-app-theme-400 focus:border-app-theme-400">
                        <input type="text" v-model="newSchedule.description" placeholder="æ´»å‹•ç´°ç¯€æè¿°"
                               class="w-full p-2 border border-gray-300 rounded-lg focus:ring-app-theme-400 focus:border-app-theme-400">
                        
                        <div class="pt-2 border-t border-app-theme-300">
                            <h4 class="font-semibold text-gray-700 mb-1">è¨˜å¸³ï¼ˆéå¿…å¡«ï¼‰</h4>
                            <input type="number" v-model.number="newSchedule.expenseAmount" placeholder="é‡‘é¡ (NT$)"
                                   class="w-full p-2 border border-gray-300 rounded-lg focus:ring-app-theme-400 focus:border-app-theme-400">
                            <input type="text" v-model="newSchedule.expenseDescription" placeholder="æ”¯å‡ºé …ç›®åç¨± (å¦‚ï¼šè¨ˆç¨‹è»Šè²»)"
                                   class="w-full p-2 border border-gray-300 rounded-lg focus:ring-app-theme-400 focus:border-app-theme-400">
                        </div>

                        <div class="flex space-x-3 pt-2">
                             <button @click="addDailyItem(); showDailyItemModal = false"
                                class="bg-app-theme-500 hover:bg-app-theme-600 w-full text-white font-bold py-2 rounded-lg transition">
                                æ–°å¢é …ç›®
                            </button>
                            <button @click="showDailyItemModal = false"
                                    class="w-full text-gray-600 font-medium py-2 rounded-lg border border-gray-300 hover:bg-gray-100 transition">
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END Modal for New Daily Item -->

            <!-- NEW Modal for Fan Color Management (æ‡‰æ´è‰²ç®¡ç†) -->
            <div v-if="showColorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-20">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm max-h-[80vh] overflow-y-auto">
                    <h2 class="text-xl font-bold text-app-theme-700">ğŸ¨ ä¸»é¡Œèˆ‡æ‡‰æ´è‰²è¨­å®š</h2>
                    
                    <!-- App Theme Settings -->
                    <div class="mb-6 p-4 border rounded-lg bg-app-theme-50 border-app-theme-300">
                        <h3 class="font-semibold text-gray-700 mb-2 border-b pb-1">App ä¸»é¡Œè‰²</h3>
                        <div class="space-y-3 mt-3">
                            <label for="theme-hex-input" class="block text-sm font-medium text-gray-700">é¸æ“‡ä¸»é¡Œ (HEX è‰²ç¢¼)ï¼š</label>
                            <input type="text" id="theme-hex-input" v-model="newThemeSelectionHex" 
                                    placeholder="#FF4B91"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-app-theme-400 focus:border-app-theme-400 uppercase">
                            
                            <p class="text-xs text-gray-600 flex items-center">
                                é è¦½: <span class="w-4 h-4 ml-2 rounded-full border border-gray-400" :style="{ backgroundColor: newThemeSelectionHex }"></span>
                            </p>

                            <button @click="saveAppTheme"
                                    :disabled="newThemeSelectionHex === currentAppThemeHex"
                                    class="bg-app-theme-500 hover:bg-app-theme-600 w-full text-white font-bold py-2 rounded-lg transition disabled:bg-gray-400">
                                æ‡‰ç”¨æ–°ä¸»é¡Œ
                            </button>
                            <p class="text-xs text-gray-600">ç•¶å‰ä¸»é¡Œ: {{ currentAppThemeHex }}</p>
                        </div>
                    </div>

                    <!-- Fan Color Settings -->
                    <div class="mb-4">
                        <h3 class="font-semibold text-gray-700 mb-2 border-b pb-1">å·²è¨­å®šå¶åƒé¡è‰²</h3>
                        <div v-if="Object.keys(fanColors).length > 0" class="space-y-2">
                            <div v-for="(color, artist) in fanColors" :key="artist"
                                 class="flex justify-between items-center p-2 bg-gray-50 rounded-lg border-l-4"
                                 :class="hexToBorderClass(color)">
                                
                                <span class="font-medium text-gray-800">{{ artist }}</span>
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm text-gray-500">{{ color }}</span>
                                    <button @click="deleteColor(artist)" class="text-red-500 hover:text-red-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p v-else class="text-sm text-gray-500">ç›®å‰æ²’æœ‰è‡ªå®šç¾©æ‡‰æ´è‰²ã€‚</p>
                    </div>

                    <!-- æ–°å¢/ç·¨è¼¯å€å¡Š -->
                    <h3 class="font-semibold text-gray-700 mb-2 border-b pt-2 pb-1">æ–°å¢ / æ›´æ–°æ‡‰æ´è‰²</h3>
                    <div class="space-y-3 mt-3">
                        <input type="text" v-model="newColorArtist" placeholder="å¶åƒ/è—äººåç¨± (å¦‚ï¼šSHINee)"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-app-theme-400 focus:border-app-theme-400">
                        
                        <input type="text" v-model="newColorClass" placeholder="é¡è‰²ä»£ç¢¼ (å¿…é ˆæ˜¯ #XXXXXX æ ¼å¼)"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-app-theme-400 focus:border-app-theme-400">
                        
                        <button @click="addOrUpdateColor"
                                :disabled="!newColorArtist || !newColorClass"
                                class="bg-app-theme-500 hover:bg-app-theme-600 w-full text-white font-bold py-3 rounded-lg transition disabled:bg-gray-400">
                            {{ fanColors[newColorArtist] ? 'æ›´æ–°æ‡‰æ´è‰²' : 'æ–°å¢æ‡‰æ´è‰²' }}
                        </button>
                        
                        <p class="text-xs text-gray-500">
                            æ‡‰æ´è‰²å¿…é ˆæ˜¯æœ‰æ•ˆçš„ HEX è‰²ç¢¼ (ä¾‹å¦‚ `#FF4B91`).
                        </p>
                    </div>

                    <button @click="showColorModal = false"
                            class="w-full text-gray-600 font-medium py-2 rounded-lg hover:text-red-500 transition mt-4 border-t pt-4">
                        é—œé–‰è¨­å®š
                    </button>
                </div>
            </div>
            <!-- END Modal for Fan Color Management -->

        </div>
    </div>

</body>
</html>
