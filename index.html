<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆ‘çš„è¿½æ˜Ÿæ—¥è¨˜ ğŸŒŸ | è¿½æ˜Ÿè¡Œç¨‹ç®¡ç†ã€è²»ç”¨ç´€éŒ„èˆ‡åœ°åœ–è¶³è·¡</title>
    
    <meta name="description" content="å°ˆç‚ºè¿½æ˜Ÿæ—è¨­è¨ˆçš„æ—¥è¨˜Appã€‚è¼•é¬†ç´€éŒ„å¶åƒæ´»å‹•è¡Œç¨‹ã€æ¼”å”±æœƒè²»ç”¨ã€è¿½æ˜Ÿè¶³è·¡åœ°åœ–ï¼Œä¸¦ç®¡ç†å‡ºç™¼å‰å¿…å¸¶æ¸…å–®ã€‚è®“æ¯ä¸€ä»½æ„›æ„éƒ½è¢«çè—ï¼">
    <meta name="keywords" content="è¿½æ˜Ÿæ—¥è¨˜, å¶åƒè¡Œç¨‹, æ¼”å”±æœƒç´€éŒ„, è¿½æ˜Ÿåœ°åœ–, ç²‰çµ²æ—¥è¨˜, æ‡‰æ´è²»ç”¨, Vue3">

    <meta property="og:title" content="æˆ‘çš„è¿½æ˜Ÿæ—¥è¨˜ ğŸŒŸ - è¡Œç¨‹è²»ç”¨ç®¡ç† App">
    <meta property="og:description" content="è¿½æ˜Ÿæ—å¿…å‚™ï¼ç´€éŒ„æ‰€æœ‰å¶åƒæ´»å‹•ã€æ¼”å”±æœƒé–€ç¥¨æ”¯å‡ºã€åœ°åœ–è¶³è·¡ï¼Œä¸å†éŒ¯éä»»ä½•ä¸€å€‹é‡è¦ç¬é–“ã€‚">
    <meta property="og:type" content="website">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/bold/style.css" />
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/duotone/style.css" />

    <style>
        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Microsoft JhengHei', 'sans-serif';
            -webkit-tap-highlight-color: transparent;
        }
        [v-cloak] { display: none; }
        .tab-item.active {
            border-bottom-width: 3px;
            font-weight: 700;
        }
        .text-glow {
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }
        /* iOS Safe Area */
        .safe-area-top {
            padding-top: constant(safe-area-inset-top);
            padding-top: env(safe-area-inset-top);
        }
        .safe-area-bottom {
            padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="app" v-cloak>
        <main :class="['min-h-screen', 'pb-24', 'safe-area-bottom', cssVars.bgColor]">
            <header class="bg-white border-b border-slate-100 sticky top-0 z-10 safe-area-top" :style="{ 'border-bottom-color': themeColor }">
                <div class="px-4 py-3 flex items-center justify-between">
                    <h1 class="text-xl font-black text-slate-800 flex items-center gap-2" @click="toggleThemeModal">
                        <i class="ph-bold ph-sparkle-fill text-xl" :style="{ color: themeColor }"></i>
                        <span v-if="customTitle">{{ customTitle }}</span>
                        <span v-else>æˆ‘çš„è¿½æ˜Ÿæ—¥è¨˜</span>
                    </h1>
                    <div class="flex items-center gap-2">
                        <button @click="toggleSettingsModal" class="p-2 rounded-full hover:bg-slate-100 transition-colors text-slate-500">
                            <i class="ph-bold ph-gear-six text-xl"></i>
                        </button>
                        <button @click="openModal('add')" class="p-2 rounded-full hover:bg-slate-100 transition-colors text-slate-500">
                            <i class="ph-bold ph-plus-circle text-xl"></i>
                        </button>
                    </div>
                </div>

                <div class="flex border-t border-slate-100 text-sm" :style="{ 'border-top-color': themeColor }">
                    <button @click="activeTab = 'home'" :class="['tab-item', 'flex-1', 'py-3', 'text-center', 'transition-colors', 'border-transparent', 'text-slate-500', activeTab === 'home' ? 'active' : '']" :style="activeTab === 'home' ? {'border-bottom-color': themeColor, 'color': themeColor} : {}">
                        <i class="ph-bold ph-calendar-blank text-lg mr-1"></i> è¡Œç¨‹
                        <span v-if="upcomingCount > 0" class="ml-1 px-1.5 py-0.5 text-xs rounded-full bg-red-500 text-white">{{ upcomingCount }}</span>
                    </button>
                    <button @click="activeTab = 'stats'" :class="['tab-item', 'flex-1', 'py-3', 'text-center', 'transition-colors', 'border-transparent', 'text-slate-500', activeTab === 'stats' ? 'active' : '']" :style="activeTab === 'stats' ? {'border-bottom-color': themeColor, 'color': themeColor} : {}">
                        <i class="ph-bold ph-chart-pie text-lg mr-1"></i> çµ±è¨ˆ
                    </button>
                    <button @click="activeTab = 'map'" :class="['tab-item', 'flex-1', 'py-3', 'text-center', 'transition-colors', 'border-transparent', 'text-slate-500', activeTab === 'map' ? 'active' : '']" :style="activeTab === 'map' ? {'border-bottom-color': themeColor, 'color': themeColor} : {}">
                        <i class="ph-bold ph-map-pin text-lg mr-1"></i> åœ°åœ–
                    </button>
                </div>
            </header>

            <div v-if="activeTab === 'home'" class="p-4">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-slate-800">{{ greetingMessage }}</h2>
                    <div class="flex items-center gap-2">
                        <select v-model="selectedYear" class="p-2 border border-slate-300 rounded-lg text-sm bg-white">
                            <option value="">å…¨éƒ¨</option>
                            <option v-for="year in availableYears" :value="year">{{ year }}</option>
                        </select>
                        <button @click="viewMode = viewMode === 'list' ? 'card' : 'list'" class="p-2 border border-slate-300 rounded-lg bg-white text-slate-600">
                            <i :class="['ph-bold', viewMode === 'list' ? 'ph-cards' : 'ph-list']"></i>
                        </button>
                    </div>
                </div>

                <div class="relative mb-4">
                    <input type="text" v-model="searchQuery" placeholder="æœå°‹æ´»å‹•åç¨±ã€è—äººã€åœ°é»æˆ–ç­†è¨˜..." class="w-full p-3 pl-10 border border-slate-300 rounded-xl focus:ring-2 focus:ring-offset-1 transition-colors" :style="{ 'border-color': themeColor, 'focus-ring-color': themeColor }">
                    <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                    <button v-if="searchQuery" @click="searchQuery = ''" class="ph-bold ph-x-circle absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600"></button>
                </div>

                <p v-if="idolNagging" class="text-sm text-center text-slate-500 p-4 bg-yellow-50 rounded-xl mb-4 border-l-4 border-yellow-400">
                    <i class="ph-bold ph-chat-text mr-1"></i> {{ idolNagging }}
                </p>

                <div v-if="filteredEvents.length" :class="viewMode === 'list' ? 'space-y-2' : 'grid grid-cols-1 md:grid-cols-2 gap-4'">
                    <div v-for="event in filteredEvents" :key="event.id" :class="['relative', 'bg-white', 'rounded-xl', 'shadow-md', 'overflow-hidden', 'transition-all', 'duration-300', viewMode === 'list' ? 'p-4 flex gap-4 border-l-4' : '']" :style="{ 'border-left-color': viewMode === 'list' ? getEventColor(event) : 'transparent' }" @click="toggleExpand(event.id)">
                        <div :class="[viewMode === 'list' ? 'shrink-0 w-16 text-center' : 'p-4 border-b border-slate-100 flex justify-between items-center']" :style="{ 'background-color': viewMode === 'card' ? cssVars.bgColor : 'white' }">
                            <div :class="['font-black', 'text-2xl']" :style="{ color: getEventColor(event) }">
                                {{ getDay(event.date) }}
                            </div>
                            <div class="text-xs font-semibold text-slate-500">
                                {{ getMonth(event.date) }}
                            </div>
                            <div v-if="viewMode === 'card'" class="flex items-center gap-2">
                                <span class="px-2 py-1 text-xs font-bold rounded-full text-white" :style="{ 'background-color': getEventColor(event) }">{{ getDaysDiff(event.date) > 0 ? `T+${getDaysDiff(event.date)}` : (getDaysDiff(event.date) === 0 ? 'ä»Šæ—¥' : `T${getDaysDiff(event.date)}`) }}</span>
                                <i :class="['ph-bold', expandedEventId === event.id ? 'ph-caret-up' : 'ph-caret-down']"></i>
                            </div>
                        </div>

                        <div :class="[viewMode === 'list' ? 'flex-1' : 'p-4']">
                            <div :class="['flex', 'items-center', 'justify-between', viewMode === 'list' ? 'mb-1' : 'mb-2']">
                                <div class="flex items-center gap-2">
                                    <h3 :class="['font-bold', viewMode === 'list' ? 'text-base' : 'text-xl', 'truncate']" :style="{ color: getEventColor(event) }">{{ event.title }}</h3>
                                    <span v-if="event.ticket" class="px-2 py-0.5 text-xs font-bold rounded-full bg-pink-500 text-white">ç¥¨</span>
                                </div>
                                <div v-if="viewMode === 'list'" class="flex items-center gap-2">
                                    <span class="px-2 py-1 text-xs font-bold rounded-full text-white" :style="{ 'background-color': getEventColor(event) }">{{ getDaysDiff(event.date) > 0 ? `T+${getDaysDiff(event.date)}` : (getDaysDiff(event.date) === 0 ? 'ä»Šæ—¥' : `T${getDaysDiff(event.date)}`) }}</span>
                                    <i :class="['ph-bold', expandedEventId === event.id ? 'ph-caret-up' : 'ph-caret-down']"></i>
                                </div>
                            </div>
                            <p class="text-sm text-slate-600 mb-1 flex items-center gap-1.5"><i class="ph-bold ph-microphone-stage text-sm"></i> {{ event.artist }}</p>
                            <p class="text-sm text-slate-500 flex items-center gap-1.5"><i class="ph-bold ph-clock text-sm"></i> {{ event.date }} {{ event.time }}</p>
                            <p v-if="event.mood" class="text-sm mt-2 flex items-center gap-1.5 text-slate-700">
                                <img :src="moodStickers[event.mood]" alt="Mood Sticker" class="w-4 h-4">
                                <span>å¿ƒæƒ…ï¼š{{ event.mood }}</span>
                            </p>
                        </div>

                        <div v-if="expandedEventId === event.id" :class="['p-4', 'border-t', 'border-slate-100', viewMode === 'list' ? 'ml-20' : '']">
                            <div class="space-y-2 mb-3">
                                <div class="flex items-center gap-1.5 text-sm text-slate-600" v-if="event.location">
                                    <i class="ph-bold ph-map-pin shrink-0" :style="{ color: getEventColor(event) }"></i>
                                    <span class="truncate">{{ event.location }}</span>
                                </div>

                                <div class="grid grid-cols-3 gap-2 pt-1">
                                    <button @click.stop="addToCalendar(event)" class="py-2 bg-slate-50 hover:bg-slate-100 border border-slate-100 rounded-lg text-[10px] font-bold text-slate-600 flex items-center justify-center gap-1.5 transition-colors">
                                        <i class="ph ph-calendar-plus text-sm"></i> æ—¥æ›†
                                    </button>
                                    
                                    <a :href="getGoogleCalendarLink(event)" @click.stop target="_blank" 
                                        class="py-2 bg-slate-50 hover:bg-slate-100 border border-slate-100 rounded-lg text-[10px] font-bold text-blue-600 flex items-center justify-center gap-1.5 transition-colors">
                                        <i class="ph ph-google-chrome text-sm"></i> Google
                                    </a>

                                    <a :href="getMapLink(event.location)" @click.stop target="_blank" class="py-2 bg-slate-50 hover:bg-slate-100 border border-slate-100 rounded-lg text-[10px] font-bold text-slate-600 flex items-center justify-center gap-1.5 transition-colors">
                                        <i class="ph ph-navigation-arrow text-sm"></i> å°èˆª
                                    </a>
                                </div>
                                
                                <div class="flex items-center justify-between mt-2 pt-2 border-t border-dashed border-slate-100">
                                    <button @click.stop="editEvent(event.id)" class="px-3 py-1 text-xs font-semibold rounded-full text-slate-600 hover:bg-slate-100 transition-colors">
                                        <i class="ph-bold ph-pencil-simple mr-1"></i> ç·¨è¼¯
                                    </button>
                                    <button @click.stop="showTicket(event)" v-if="event.ticket" class="px-3 py-1 text-xs font-semibold rounded-full text-pink-600 hover:bg-pink-50 transition-colors">
                                        <i class="ph-bold ph-ticket mr-1"></i> ç¥¨å‹™è©³æƒ… ({{ formatMoney(getTicketPrice(event)) }})
                                    </button>
                                </div>

                                <div v-if="event.memo" class="mt-3 text-sm p-3 bg-slate-50 rounded-lg border border-slate-100 whitespace-pre-wrap">
                                    <strong class="text-slate-700">æˆ‘çš„å¿ƒå¾—ç­†è¨˜:</strong><br>{{ event.memo }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else class="text-center p-10 text-slate-500">
                    <i class="ph-bold ph-ghost text-4xl mb-3"></i>
                    <p class="text-lg font-semibold">
                        <span v-if="searchQuery">æ‰¾ä¸åˆ°ç›¸é—œè¡Œç¨‹</span>
                        <span v-else>é‚„æ²’æœ‰ç´€éŒ„ä»»ä½•è¡Œç¨‹ï¼</span>
                    </p>
                    <p v-if="!searchQuery" class="text-sm mt-1">é»æ“Šå³ä¸Šæ–¹ <i class="ph-bold ph-plus-circle"></i> é–‹å§‹è¨˜éŒ„æ‚¨çš„ç¬¬ä¸€ç­†è¿½æ˜Ÿæ—¥è¨˜å§ï¼</p>
                </div>
            </div>

            <div v-if="activeTab === 'stats'" class="p-4">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">è¿½æ˜Ÿæˆæœçµ±è¨ˆ</h2>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-md border-l-4" :style="{'border-color': themeColor}">
                        <p class="text-sm text-slate-500 font-medium">ç¸½å…±èŠ±äº† (ç•¶å¹´)</p>
                        <p class="text-3xl font-black text-slate-800 mt-1">
                            <span :class="{'text-glow': !isPrivacyMode}">{{ isPrivacyMode ? '***' : formatMoney(currentYearExpense) }}</span>
                        </p>
                        <p class="text-xs text-slate-400 mt-1">NTD</p>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-md border-l-4" :style="{'border-color': themeColor}">
                        <p class="text-sm text-slate-500 font-medium">ç´¯ç©æ´»å‹• (ç¸½æ•¸)</p>
                        <p class="text-3xl font-black text-slate-800 mt-1">{{ events.length }} å ´</p>
                        <p class="text-xs text-slate-400 mt-1">{{ selectedYear || 'æ‰€æœ‰å¹´ä»½' }}</p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="ph-bold ph-chart-line text-lg" :style="{ color: themeColor }"></i> å¹´åº¦æ´»å‹•èˆ‡èŠ±è²»</h3>
                    <div class="space-y-4">
                        <div v-for="(data, key) in statsData.yearlyExpenses" :key="key" class="border-b pb-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-semibold text-slate-800">{{ key }}</span>
                                <span class="text-xs text-slate-500">{{ data.count }} å ´æ´»å‹•</span>
                            </div>
                            <div class="bg-slate-100 rounded-full h-2.5">
                                <div class="h-2.5 rounded-full transition-all duration-500" :style="{ width: `${(data.expense / statsData.maxExpenseYear * 100) || 0}%`, 'background-color': themeColor }"></div>
                            </div>
                            <p class="text-xs text-slate-600 mt-1 text-right">èŠ±è²»: <span :class="{'text-glow': !isPrivacyMode}">{{ isPrivacyMode ? '***' : formatMoney(data.expense) }}</span> NTD</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="ph-bold ph-star text-lg" :style="{ color: themeColor }"></i> è—äººç†±åº¦æ’è¡Œ ({{ selectedYear || 'ç¸½è¨ˆ' }})</h3>
                    <div class="space-y-2">
                        <div v-for="(artist, index) in statsData.topArtists" :key="artist.name" class="flex justify-between items-center pb-2 border-b border-dashed border-slate-100">
                            <div class="flex items-center gap-2">
                                <span class="font-bold w-4 text-center" :style="{ color: getEventColor({artist: artist.name}) }">{{ index + 1 }}</span>
                                <span class="text-sm text-slate-700 font-medium">{{ artist.name }}</span>
                            </div>
                            <span class="text-xs font-bold px-2 py-0.5 rounded-full text-white" :style="{ 'background-color': getEventColor({artist: artist.name}) }">{{ artist.count }} å ´</span>
                        </div>
                    </div>
                    <p v-if="statsData.topArtists.length === 0" class="text-center text-sm text-slate-400 pt-2">ç›®å‰æ²’æœ‰è—äººæ•¸æ“š</p>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-md">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="ph-bold ph-smiley text-lg" :style="{ color: themeColor }"></i> å¿ƒæƒ…ç¸½çµ</h3>
                    <div class="flex items-center justify-around gap-4">
                        <div v-for="(summary, mood) in emotionalSummary" :key="mood" class="text-center">
                            <img :src="moodStickers[mood]" :alt="mood" class="w-10 h-10 mx-auto mb-1">
                            <p class="text-xs font-medium text-slate-700">{{ mood }}</p>
                            <p class="text-xl font-black text-slate-800">{{ summary.count }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="activeTab === 'map'" class="p-4">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">è¿½æ˜Ÿåœ°åœ–è¶³è·¡</h2>
                <div class="bg-white p-4 rounded-xl shadow-md">
                    <div v-if="!isSearching" class="text-center p-4">
                        <i class="ph-duotone ph-map-pin text-5xl mx-auto" :style="{ color: themeColor }"></i>
                        <p class="text-lg font-semibold text-slate-700 mt-2">é»æ“Šé–‹å§‹åœ°åœ–åº§æ¨™æœå°‹</p>
                        <p class="text-sm text-slate-500 mb-4">å°‡è‡ªå‹•æŸ¥æ‰¾æ‚¨è¨˜éŒ„çš„æ´»å‹•åœ°é»ï¼Œä¸¦æ›´æ–°åº§æ¨™ä»¥ä¾¿åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºã€‚</p>
                        <button @click="searchCoordinates" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-colors">
                            é–‹å§‹æœå°‹ ({{ missingCoordsCount }} å€‹åœ°é»)
                        </button>
                    </div>
                    
                    <div v-else class="text-center p-4">
                        <i class="ph-duotone ph-compass text-5xl mx-auto animate-spin" :style="{ color: themeColor }"></i>
                        <p class="text-lg font-semibold text-slate-700 mt-2">æ­£åœ¨æœå°‹åº§æ¨™...</p>
                        <p class="text-sm text-slate-500">å·²è™•ç† {{ mappedEventsCount }} / {{ events.length }} å ´æ´»å‹•</p>
                        <div v-if="searchError" class="mt-4 p-2 bg-red-100 text-red-600 rounded-lg text-sm">{{ searchError }}</div>
                    </div>
                </div>

                <div class="mt-4 bg-white p-4 rounded-xl shadow-md">
                    <h3 class="font-bold text-slate-700 mb-4">å·²ç´€éŒ„çš„åœ°é» ({{ mappedEventsCount }} å€‹)</h3>
                    <div class="space-y-2">
                        <div v-for="event in events.filter(e => e.coordinates)" :key="event.id" class="flex items-center justify-between p-2 bg-slate-50 rounded-lg">
                            <div class="flex items-center gap-2">
                                <i class="ph-bold ph-map-pin" :style="{ color: getEventColor(event) }"></i>
                                <span class="text-sm font-medium text-slate-700">{{ event.location }}</span>
                            </div>
                            <span class="text-xs text-slate-500">{{ event.coordinates }}</span>
                        </div>
                    </div>
                    <p v-if="mappedEventsCount === 0 && !isSearching" class="text-center text-sm text-slate-400 pt-2">ç›®å‰æ²’æœ‰å¯é¡¯ç¤ºçš„åœ°é»</p>
                </div>
            </div>
        </main>

        <div v-if="showModal" class="fixed inset-0 bg-black bg-opacity-50 z-20 flex items-center justify-center p-4" @click.self="closeModal">
            <div class="bg-white rounded-xl w-full max-w-lg overflow-hidden shadow-2xl safe-area-top safe-area-bottom" @click.stop>
                <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-800">{{ isEditing ? 'ç·¨è¼¯è¿½æ˜Ÿè¡Œç¨‹' : 'æ–°å¢è¿½æ˜Ÿè¡Œç¨‹' }}</h3>
                    <button @click="closeModal" class="p-2 rounded-full hover:bg-slate-100 text-slate-500">
                        <i class="ph-bold ph-x text-xl"></i>
                    </button>
                </div>
                
                <form @submit.prevent="saveEvent" class="p-5 overflow-y-auto max-h-[80vh]">
                    <div class="space-y-4">
                        <label class="block">
                            <span class="text-sm font-semibold text-slate-700 flex items-center gap-1.5"><i class="ph-bold ph-sparkle" :style="{ color: themeColor }"></i> æ´»å‹•åç¨± <span class="text-red-500">*</span></span>
                            <input type="text" v-model="form.title" required class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-offset-1 transition-colors" :style="{ 'border-color': themeColor, 'focus-ring-color': themeColor }">
                        </label>
                        
                        <label class="block">
                            <span class="text-sm font-semibold text-slate-700 flex items-center gap-1.5"><i class="ph-bold ph-microphone-stage"></i> è—äºº/åœ˜é«” <span class="text-red-500">*</span></span>
                            <input type="text" v-model="form.artist" required class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-offset-1 transition-colors" :style="{ 'border-color': themeColor, 'focus-ring-color': themeColor }">
                        </label>

                        <div class="grid grid-cols-2 gap-4">
                            <label class="block">
                                <span class="text-sm font-semibold text-slate-700 flex items-center gap-1.5"><i class="ph-bold ph-calendar"></i> æ—¥æœŸ <span class="text-red-500">*</span></span>
                                <input type="date" v-model="form.date" required class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-offset-1 transition-colors" :style="{ 'border-color': themeColor, 'focus-ring-color': themeColor }">
                            </label>
                            <label class="block">
                                <span class="text-sm font-semibold text-slate-700 flex items-center gap-1.5"><i class="ph-bold ph-clock"></i> æ™‚é–“</span>
                                <input type="time" v-model="form.time" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-offset-1 transition-colors" :style="{ 'border-color': themeColor, 'focus-ring-color': themeColor }">
                            </label>
                        </div>
                        
                        <label class="block">
                            <span class="text-sm font-semibold text-slate-700 flex items-center gap-1.5"><i class="ph-bold ph-map-pin"></i> åœ°é»</span>
                            <input type="text" v-model="form.location" placeholder="ä¾‹å¦‚ï¼šå°åŒ—å°å·¨è›‹" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-offset-1 transition-colors" :style="{ 'border-color': themeColor, 'focus-ring-color': themeColor }">
                        </label>

                        <label class="block">
                            <span class="text-sm font-semibold text-slate-700 flex items-center gap-1.5"><i class="ph-bold ph-smiley"></i> å¿ƒæƒ…ç´€éŒ„</span>
                            <select v-model="form.mood" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-offset-1 transition-colors bg-white" :style="{ 'border-color': themeColor, 'focus-ring-color': themeColor }">
                                <option value="">(é¸æ“‡å¿ƒæƒ…)</option>
                                <option v-for="(sticker, mood) in moodStickers" :value="mood">{{ mood }}</option>
                            </select>
                        </label>

                        <label class="block">
                            <span class="text-sm font-semibold text-slate-700 flex items-center gap-1.5"><i class="ph-bold ph-notebook"></i> å¿ƒå¾—ç­†è¨˜</span>
                            <textarea v-model="form.memo" rows="3" placeholder="è¨˜éŒ„è¿½æ˜Ÿæ™‚çš„æ„Ÿå‹•ã€è¶£äº‹ã€æˆ–æ˜¯æº–å‚™äº‹é …..." class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-offset-1 transition-colors" :style="{ 'border-color': themeColor, 'focus-ring-color': themeColor }"></textarea>
                        </label>

                        <div class="border border-dashed p-4 rounded-lg" :style="{ 'border-color': themeColor }">
                            <div class="flex items-center gap-2 mb-3">
                                <input type="checkbox" id="hasTicket" v-model="form.ticket.hasTicket" class="w-4 h-4" :style="{ 'accent-color': themeColor }">
                                <label for="hasTicket" class="text-base font-bold text-slate-700 flex items-center gap-1.5"><i class="ph-bold ph-ticket" :style="{ color: themeColor }"></i> ç´€éŒ„ç¥¨å‹™èˆ‡è²»ç”¨</label>
                            </div>

                            <div v-if="form.ticket.hasTicket" class="space-y-3 mt-3">
                                <label class="block">
                                    <span class="text-sm font-semibold text-slate-700">é–€ç¥¨/å‘¨é‚Šç¸½èŠ±è²» (NTD)</span>
                                    <input type="number" v-model.number="form.ticket.totalExpense" min="0" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-offset-1 transition-colors" :style="{ 'border-color': themeColor, 'focus-ring-color': themeColor }">
                                </label>
                                
                                <label class="block">
                                    <span class="text-sm font-semibold text-slate-700">åº§ä½/å€åŸŸè³‡è¨Š</span>
                                    <input type="text" v-model="form.ticket.seatInfo" placeholder="ä¾‹å¦‚ï¼šç´…å€1æ¨“1æ’1è™Ÿ" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-offset-1 transition-colors" :style="{ 'border-color': themeColor, 'focus-ring-color': themeColor }">
                                </label>

                                <h4 class="font-bold text-slate-700 mt-4 border-t pt-3 flex items-center justify-between">
                                    è²»ç”¨ç´°é …
                                    <button type="button" @click="addExpenseItem" class="text-xs text-blue-500 font-semibold hover:text-blue-600">
                                        <i class="ph-bold ph-plus-circle mr-1"></i> æ–°å¢
                                    </button>
                                </h4>
                                <div v-for="(item, index) in form.ticket.expenses" :key="index" class="flex gap-2 items-center bg-slate-50 p-2 rounded-lg">
                                    <input type="text" v-model="item.name" placeholder="åç¨± (e.g. é–€ç¥¨, æ‰‹ç‡ˆ)" class="flex-1 p-2 border border-slate-200 rounded-lg text-sm">
                                    <input type="number" v-model.number="item.amount" placeholder="é‡‘é¡" class="w-20 p-2 border border-slate-200 rounded-lg text-sm text-right">
                                    <button type="button" @click="removeExpenseItem(index)" class="p-1 text-red-500 hover:bg-red-50 rounded-full">
                                        <i class="ph-bold ph-x text-sm"></i>
                                    </button>
                                </div>
                                <p class="text-sm font-bold text-right text-slate-700 mt-2">ç¸½è¨ˆ: {{ formatMoney(calculateTotal(form.ticket.expenses)) }} NTD</p>
                                
                                <h4 class="font-bold text-slate-700 mt-4 border-t pt-3 flex items-center justify-between">
                                    å‡ºç™¼å‰å¾…è¾¦æ¸…å–®
                                    <div class="flex gap-2">
                                        <button type="button" @click="addDefaultChecklist" class="text-xs text-green-500 font-semibold hover:text-green-600">
                                            <i class="ph-bold ph-list-checks mr-1"></i> é è¨­æ¸…å–®
                                        </button>
                                        <button type="button" @click="addChecklistItem" class="text-xs text-blue-500 font-semibold hover:text-blue-600">
                                            <i class="ph-bold ph-plus-circle mr-1"></i> æ–°å¢
                                        </button>
                                    </div>
                                </h4>
                                <div v-for="(item, index) in form.ticket.checklist" :key="index" class="flex gap-2 items-center bg-slate-50 p-2 rounded-lg">
                                    <input type="checkbox" v-model="item.checked" @change="saveChecklistState(form.id)" class="w-4 h-4" :style="{ 'accent-color': themeColor }">
                                    <input type="text" v-model="item.task" placeholder="å¾…è¾¦äº‹é …" class="flex-1 p-2 border border-slate-200 rounded-lg text-sm">
                                    <button type="button" @click="removeChecklistItem(index)" class="p-1 text-red-500 hover:bg-red-50 rounded-full">
                                        <i class="ph-bold ph-x text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center pt-4 border-t border-slate-100">
                            <button v-if="isEditing" type="button" @click="deleteEvent(form.id)" class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition-colors">
                                <i class="ph-bold ph-trash-simple mr-1"></i> åˆªé™¤
                            </button>
                            <span v-else></span>
                            <button type="submit" class="px-6 py-2 text-white rounded-lg font-semibold transition-colors" :style="{ 'background-color': themeColor, 'hover-bg-color': themeColor }">
                                <i class="ph-bold ph-check-circle mr-1"></i> {{ isEditing ? 'å„²å­˜è®Šæ›´' : 'æ–°å¢è¡Œç¨‹' }}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div v-if="showTicketModal" class="fixed inset-0 bg-black bg-opacity-50 z-20 flex items-center justify-center p-4" @click.self="showTicketModal = false">
            <div class="bg-white rounded-xl w-full max-w-lg overflow-hidden shadow-2xl" @click.stop>
                <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-pink-600 flex items-center gap-2"><i class="ph-bold ph-ticket"></i> {{ ticketEvent.title }} ç¥¨å‹™è©³æƒ…</h3>
                    <button @click="showTicketModal = false" class="p-2 rounded-full hover:bg-slate-100 text-slate-500">
                        <i class="ph-bold ph-x text-xl"></i>
                    </button>
                </div>
                
                <div class="p-5 overflow-y-auto max-h-[80vh] space-y-4">
                    <div class="p-3 bg-pink-50 rounded-lg border-l-4 border-pink-400">
                        <p class="text-sm font-semibold text-pink-700">ç¸½èŠ±è²» (NTD)</p>
                        <p class="text-2xl font-black text-pink-800 mt-1"><span :class="{'text-glow': !isPrivacyMode}">{{ isPrivacyMode ? '***' : formatMoney(getTicketPrice(ticketEvent)) }}</span></p>
                    </div>

                    <div v-if="ticketEvent.ticket.seatInfo" class="p-3 bg-slate-50 rounded-lg border-l-4 border-slate-300">
                        <p class="text-sm font-semibold text-slate-700">åº§ä½/å€åŸŸ</p>
                        <p class="text-base font-bold text-slate-800 mt-1">{{ ticketEvent.ticket.seatInfo }}</p>
                    </div>

                    <div v-if="ticketEvent.ticket.expenses.length" class="border p-4 rounded-lg">
                        <h4 class="font-bold text-slate-700 mb-2">è²»ç”¨ç´°é …</h4>
                        <ul class="space-y-1">
                            <li v-for="item in ticketEvent.ticket.expenses" :key="item.name" class="flex justify-between items-center text-sm text-slate-600 border-b border-dashed pb-1 last:border-b-0">
                                <span>{{ item.name }}</span>
                                <span class="font-semibold">{{ formatMoney(item.amount) }} NTD</span>
                            </li>
                        </ul>
                    </div>

                    <div v-if="ticketEvent.ticket.checklist.length" class="border p-4 rounded-lg" :style="{ 'border-color': themeColor }">
                        <h4 class="font-bold text-slate-700 mb-2 flex items-center gap-2"><i class="ph-bold ph-list-checks" :style="{ color: themeColor }"></i> å‡ºç™¼å‰å¾…è¾¦æ¸…å–®</h4>
                        <ul class="space-y-1">
                            <li v-for="item in ticketEvent.ticket.checklist" :key="item.task" class="flex items-center gap-2 text-sm text-slate-700">
                                <i :class="['ph-bold', item.checked ? 'ph-check-circle text-green-500' : 'ph-circle text-slate-400']"></i>
                                <span :class="{'line-through text-slate-400': item.checked}">{{ item.task }}</span>
                            </li>
                        </ul>
                        <p class="text-xs text-right text-slate-500 mt-2">è¨˜å¾—åœ¨ç·¨è¼¯é é¢å®Œæˆæ‰“å‹¾ï¼</p>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showThemeModal" class="fixed inset-0 bg-black bg-opacity-50 z-20 flex items-center justify-center p-4" @click.self="toggleThemeModal">
            <div class="bg-white rounded-xl w-full max-w-sm overflow-hidden shadow-2xl" @click.stop>
                <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="ph-bold ph-palette" :style="{ color: themeColor }"></i> ä¸»é¡Œèˆ‡é¡è‰²</h3>
                    <button @click="toggleThemeModal" class="p-2 rounded-full hover:bg-slate-100 text-slate-500">
                        <i class="ph-bold ph-x text-xl"></i>
                    </button>
                </div>
                
                <div class="p-5 space-y-4">
                    <h4 class="font-bold text-slate-700">é è¨­ä¸»é¡Œè‰²</h4>
                    <div class="grid grid-cols-5 gap-3">
                        <button v-for="color in presetColors" :key="color.name" @click="setTheme(color.hex)" class="w-full aspect-square rounded-lg flex items-center justify-center border-4 transition-colors" :style="{'background-color': color.hex, 'border-color': themeColor === color.hex ? 'rgba(255,255,255,0.7)' : 'transparent'}">
                            <i v-if="themeColor === color.hex" class="ph-bold ph-check text-white text-xl text-glow"></i>
                        </button>
                    </div>

                    <h4 class="font-bold text-slate-700 pt-4 border-t">è‡ªè¨‚é¡è‰²</h4>
                    <input type="color" v-model="form.customTheme" @change="updateCustomTheme" class="w-full h-10 rounded-lg border-2 border-slate-200">
                </div>
            </div>
        </div>
        
        <div v-if="showSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-20 flex items-center justify-center p-4" @click.self="toggleSettingsModal">
            <div class="bg-white rounded-xl w-full max-w-lg overflow-hidden shadow-2xl safe-area-top safe-area-bottom" @click.stop>
                <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="ph-bold ph-gear-six" :style="{ color: themeColor }"></i> æ‡‰ç”¨ç¨‹å¼è¨­å®š</h3>
                    <button @click="toggleSettingsModal" class="p-2 rounded-full hover:bg-slate-100 text-slate-500">
                        <i class="ph-bold ph-x text-xl"></i>
                    </button>
                </div>
                
                <div class="p-5 overflow-y-auto max-h-[80vh] space-y-6">
                    <div>
                        <h4 class="font-bold text-slate-700 mb-2 flex items-center gap-2"><i class="ph-bold ph-text-aa"></i> è‡ªè¨‚æ‡‰ç”¨ç¨‹å¼æ¨™é¡Œ</h4>
                        <input type="text" v-model="customTitle" @input="updateAppTitle" placeholder="ä¾‹å¦‚ï¼šæŸæŸæŸçš„è¿½æ˜Ÿå®‡å®™" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-offset-1 transition-colors">
                        <p class="text-xs text-slate-500 mt-1">æ¨™é¡Œå°‡é¡¯ç¤ºåœ¨æ‡‰ç”¨ç¨‹å¼é ‚éƒ¨ã€‚</p>
                    </div>

                    <div class="flex justify-between items-center border-t border-slate-100 pt-4">
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-700">éš±ç§æ¨¡å¼</h4>
                            <p class="text-sm text-slate-500">å•Ÿç”¨å¾Œï¼Œæ‰€æœ‰èŠ±è²»æ•¸å­—å°‡è¢«éš±è—ç‚º `***`ã€‚</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" v-model="isPrivacyMode" @change="togglePrivacy" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all" :style="{ 'background-color': isPrivacyMode ? themeColor : '' }"></div>
                        </label>
                    </div>

                    <div class="border-t border-slate-100 pt-4">
                        <h4 class="font-bold text-slate-700 mb-2 flex items-center gap-2"><i class="ph-bold ph-archive"></i> è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h4>
                        <div class="flex gap-2 mb-3">
                            <button @click="downloadBackup" class="flex-1 py-2 bg-green-500 text-white rounded-lg font-semibold text-sm hover:bg-green-600 transition-colors">
                                <i class="ph-bold ph-download-simple mr-1"></i> ä¸‹è¼‰å‚™ä»½ (.json)
                            </button>
                            <button @click="toggleImportModal" class="flex-1 py-2 bg-yellow-500 text-white rounded-lg font-semibold text-sm hover:bg-yellow-600 transition-colors">
                                <i class="ph-bold ph-upload-simple mr-1"></i> é‚„åŸè³‡æ–™
                            </button>
                        </div>
                        <p class="text-xs text-slate-500">æ‰€æœ‰è³‡æ–™çš†å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œå»ºè­°å®šæœŸå‚™ä»½ã€‚</p>
                    </div>

                    <div class="border-t border-slate-100 pt-4 text-center">
                        <p class="text-xs text-slate-400">æˆ‘çš„è¿½æ˜Ÿæ—¥è¨˜ App - Vue3 + TailwindCSS ç¯„ä¾‹</p>
                        <p class="text-xs text-slate-400 mt-1">Version 1.1 | Developed with â¤ï¸</p>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showImportModal" class="fixed inset-0 bg-black bg-opacity-50 z-30 flex items-center justify-center p-4" @click.self="toggleImportModal">
            <div class="bg-white rounded-xl w-full max-w-sm overflow-hidden shadow-2xl" @click.stop>
                <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="ph-bold ph-upload-simple" :style="{ color: themeColor }"></i> é‚„åŸè³‡æ–™</h3>
                    <button @click="toggleImportModal" class="p-2 rounded-full hover:bg-slate-100 text-slate-500">
                        <i class="ph-bold ph-x text-xl"></i>
                    </button>
                </div>
                
                <div class="p-5 space-y-4">
                    <p class="text-sm text-slate-600">è«‹è²¼ä¸Šæ‚¨å…ˆå‰å‚™ä»½çš„ JSON æ ¼å¼è³‡æ–™ï¼Œé‚„åŸå°‡æœƒè¦†è“‹ç¾æœ‰æ‰€æœ‰è³‡æ–™ã€‚</p>
                    <textarea v-model="importJson" rows="8" placeholder="è²¼ä¸Šæ‚¨çš„å‚™ä»½ JSON è³‡æ–™..." class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-offset-1 transition-colors"></textarea>
                    
                    <button @click="processImport" :disabled="!importJson" class="w-full py-3 text-white rounded-lg font-semibold transition-colors disabled:bg-slate-400" :style="{ 'background-color': themeColor }">
                        <i class="ph-bold ph-check-circle mr-1"></i> ç¢ºèªé‚„åŸè³‡æ–™
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, watch, reactive, onMounted } = Vue;

        createApp({
            setup() {
                const APP_KEY = 'star_diary_app_v1';
                const EVENTS_KEY = `${APP_KEY}_events`;
                const SETTINGS_KEY = `${APP_KEY}_settings`;
                
                // æ•¸æ“šç‹€æ…‹
                const events = ref([]);
                const activeTab = ref('home');
                const viewMode = ref('list'); // 'list' æˆ– 'card'
                const themeColor = ref('#FF69B4'); // é è¨­ä¸»é¡Œè‰²
                const customTitle = ref(''); // è‡ªè¨‚æ‡‰ç”¨ç¨‹å¼æ¨™é¡Œ
                const selectedYear = ref('');
                const expandedEventId = ref(null);
                const isPrivacyMode = ref(false);
                const searchQuery = ref('');

                // Modal ç‹€æ…‹
                const showModal = ref(false);
                const showThemeModal = ref(false);
                const showSettingsModal = ref(false);
                const showImportModal = ref(false);
                const showTicketModal = ref(false);

                const ticketEvent = ref(null);
                const isEditing = ref(false);
                const form = reactive({
                    id: null,
                    title: '',
                    artist: '',
                    date: '',
                    time: '19:30',
                    location: '',
                    coordinates: '',
                    memo: '',
                    mood: '',
                    ticket: {
                        hasTicket: false,
                        totalExpense: 0,
                        seatInfo: '',
                        expenses: [],
                        checklist: [],
                    }
                });
                const importJson = ref('');
                const searchError = ref('');
                const isSearching = ref(false);

                // é è¨­è³‡æ–™/è¨­å®š
                const presetColors = [
                    { name: 'Pink', hex: '#FF69B4' },
                    { name: 'Purple', hex: '#8A2BE2' },
                    { name: 'Blue', hex: '#1E90FF' },
                    { name: 'Green', hex: '#3CB371' },
                    { name: 'Red', hex: '#FF4500' },
                ];
                const moodStickers = {
                    'è¶…ç´šå¹¸ç¦': 'https://s3.bmp.ovh/imgs/2023/12/03/4096058e11ed9f57.png',
                    'å¾ˆæ»¿è¶³': 'https://s3.bmp.ovh/imgs/2023/12/03/f303259e2b10228e.png',
                    'å¥½æƒ³å“­': 'https://s3.bmp.ovh/imgs/2023/12/03/52b9048f029c0717.png',
                    'æ™®é€š': 'https://s3.bmp.ovh/imgs/2023/12/03/61a7a4f913e61c77.png',
                    'ç´¯äº†': 'https://s3.bmp.ovh/imgs/2023/12/03/52f6368d1f2e8f17.png',
                };
                const defaultChecklistItems = [
                    'é–€ç¥¨/é›»å­ç¥¨åˆ¸',
                    'æ‡‰æ´æ‰‹ç‡ˆ/å‘¨é‚Š',
                    'èº«ä»½è­‰ä»¶/ä¿¡ç”¨å¡',
                    'äº¤é€šå¡/é›¶éŒ¢',
                    'æ‰‹æ©Ÿ/å……é›»å¯¶',
                    'æ°´/é›¶é£Ÿ',
                    'æœ›é é¡ (å¦‚æœéœ€è¦)',
                ];

                // Computed å±¬æ€§
                const cssVars = computed(() => ({
                    bgColor: 'bg-slate-50', // é ç•™çµ¦æœªä¾†ä¸»é¡Œæ¨¡å¼
                }));
                
                const greetingMessage = computed(() => {
                    const hour = new Date().getHours();
                    if (hour < 6) return 'å¤œæ·±äº†ï¼Œé‚„åœ¨è¿½æ˜Ÿå—ï¼Ÿ';
                    if (hour < 12) return 'æ—©å®‰ï¼Œè¿½æ˜Ÿäººï¼';
                    if (hour < 18) return 'ä¸‹åˆå¥½ï¼Œæº–å‚™å‡ºç™¼äº†å—ï¼Ÿ';
                    return 'æ™šä¸Šå¥½ï¼Œä»Šæ™šæœ‰ä»€éº¼æ´»å‹•ï¼Ÿ';
                });

                const filteredEvents = computed(() => {
                    let list = events.value.slice().sort((a, b) => new Date(b.date) - new Date(a.date));

                    // å¹´ä»½éæ¿¾
                    if (selectedYear.value) {
                        list = list.filter(event => event.date.startsWith(selectedYear.value));
                    }

                    // æœå°‹éæ¿¾
                    if (searchQuery.value) {
                        const query = searchQuery.value.toLowerCase();
                        list = list.filter(event => 
                            event.title.toLowerCase().includes(query) ||
                            event.artist.toLowerCase().includes(query) ||
                            (event.location && event.location.toLowerCase().includes(query)) ||
                            (event.memo && event.memo.toLowerCase().includes(query))
                        );
                    }

                    return list;
                });

                const upcomingCount = computed(() => {
                    const today = new Date().toISOString().split('T')[0];
                    return events.value.filter(event => event.date >= today).length;
                });
                
                const currentYearExpense = computed(() => {
                    const currentYear = new Date().getFullYear().toString();
                    return events.value
                        .filter(event => event.date.startsWith(currentYear) && event.ticket.hasTicket)
                        .reduce((total, event) => total + (event.ticket.totalExpense || 0), 0);
                });

                const statsData = computed(() => {
                    const currentYear = selectedYear.value || new Date().getFullYear().toString();
                    
                    // 1. å¹´åº¦èŠ±è²»
                    const yearlyExpenses = events.value.reduce((acc, event) => {
                        const year = event.date.substring(0, 4);
                        if (!acc[year]) acc[year] = { expense: 0, count: 0 };
                        acc[year].count++;
                        if (event.ticket.hasTicket) {
                            acc[year].expense += (event.ticket.totalExpense || 0);
                        }
                        return acc;
                    }, {});

                    // 2. è—äººç†±åº¦ (éæ¿¾å¹´ä»½)
                    const artistCounts = filteredEvents.value.reduce((acc, event) => {
                        const artistName = event.artist.trim();
                        if (artistName) {
                            acc[artistName] = (acc[artistName] || 0) + 1;
                        }
                        return acc;
                    }, {});

                    const topArtists = Object.entries(artistCounts)
                        .map(([name, count]) => ({ name, count }))
                        .sort((a, b) => b.count - a.count);

                    return {
                        yearlyExpenses,
                        maxExpenseYear: Math.max(...Object.values(yearlyExpenses).map(y => y.expense), 1),
                        topArtists,
                    };
                });

                const emotionalSummary = computed(() => {
                    return Object.keys(moodStickers).reduce((acc, mood) => {
                        acc[mood] = { 
                            count: filteredEvents.value.filter(e => e.mood === mood).length,
                        };
                        return acc;
                    }, {});
                });
                
                const availableYears = computed(() => {
                    const years = new Set(events.value.map(e => e.date.substring(0, 4)));
                    return Array.from(years).sort((a, b) => b - a);
                });

                const mappedEventsCount = computed(() => {
                    return events.value.filter(e => e.coordinates).length;
                });

                const missingCoordsCount = computed(() => {
                    return events.value.filter(e => e.location && !e.coordinates).length;
                });

                // Watchers
                watch(events, (newEvents) => {
                    localStorage.setItem(EVENTS_KEY, JSON.stringify(newEvents));
                }, { deep: true });

                watch([themeColor, isPrivacyMode, customTitle], () => {
                    localStorage.setItem(SETTINGS_KEY, JSON.stringify({
                        themeColor: themeColor.value,
                        isPrivacyMode: isPrivacyMode.value,
                        customTitle: customTitle.value,
                    }));
                });

                // Methods
                const loadData = () => {
                    const storedEvents = localStorage.getItem(EVENTS_KEY);
                    if (storedEvents) {
                        // è™•ç†èˆŠè³‡æ–™è½‰æ›ï¼Œç¢ºä¿ ticket çµæ§‹å­˜åœ¨
                        events.value = JSON.parse(storedEvents).map(event => ({
                            ...event,
                            ticket: event.ticket || { hasTicket: false, totalExpense: 0, seatInfo: '', expenses: [], checklist: [] },
                        }));
                    }
                    
                    const storedSettings = localStorage.getItem(SETTINGS_KEY);
                    if (storedSettings) {
                        const settings = JSON.parse(storedSettings);
                        themeColor.value = settings.themeColor || '#FF69B4';
                        isPrivacyMode.value = settings.isPrivacyMode || false;
                        customTitle.value = settings.customTitle || '';
                    }
                };

                const updateAppTitle = () => {
                    document.title = customTitle.value ? `${customTitle.value} ğŸŒŸ | è¿½æ˜Ÿæ—¥è¨˜` : 'æˆ‘çš„è¿½æ˜Ÿæ—¥è¨˜ ğŸŒŸ | è¿½æ˜Ÿè¡Œç¨‹ç®¡ç†ã€è²»ç”¨ç´€éŒ„èˆ‡åœ°åœ–è¶³è·¡';
                };

                const resetForm = () => {
                    Object.assign(form, {
                        id: null,
                        title: '',
                        artist: '',
                        date: new Date().toISOString().split('T')[0],
                        time: '19:30',
                        location: '',
                        coordinates: '',
                        memo: '',
                        mood: '',
                        ticket: {
                            hasTicket: false,
                            totalExpense: 0,
                            seatInfo: '',
                            expenses: [],
                            checklist: [],
                        }
                    });
                };

                const openModal = (mode, event = null) => {
                    resetForm();
                    isEditing.value = mode === 'edit';
                    
                    if (event) {
                        Object.assign(form, event);
                    }
                    
                    showModal.value = true;
                };

                const editEvent = (id) => {
                    const eventToEdit = events.value.find(e => e.id === id);
                    if (eventToEdit) {
                        openModal('edit', JSON.parse(JSON.stringify(eventToEdit)));
                    }
                };

                const closeModal = () => {
                    showModal.value = false;
                    resetForm();
                };

                const saveEvent = () => {
                    if (!form.title || !form.artist || !form.date) {
                        alert('è«‹å¡«å¯«æ´»å‹•åç¨±ã€è—äººã€æ—¥æœŸ');
                        return;
                    }

                    // ç¢ºä¿ expense ç¸½é¡èˆ‡ totalExpense åŒæ­¥ (å¦‚æœç´°é …æœ‰å¡«å¯«)
                    if (form.ticket.hasTicket && form.ticket.expenses.length > 0) {
                        form.ticket.totalExpense = calculateTotal(form.ticket.expenses);
                    }

                    const eventData = JSON.parse(JSON.stringify(form));
                    
                    if (isEditing.value && form.id) {
                        const index = events.value.findIndex(e => e.id === form.id);
                        if (index !== -1) {
                            // ä¿ç•™èˆŠçš„åº§æ¨™ï¼Œé™¤éåœ°é»è¢«ä¿®æ”¹
                            const oldEvent = events.value[index];
                            if (oldEvent.location !== eventData.location) {
                                eventData.coordinates = ''; // æ¸…ç©ºåº§æ¨™ï¼Œç­‰å¾…é‡æ–°æœå°‹
                            } else {
                                eventData.coordinates = oldEvent.coordinates;
                            }
                            events.value[index] = eventData;
                        }
                    } else {
                        eventData.id = Date.now().toString();
                        events.value.unshift(eventData);
                    }
                    
                    closeModal();
                };

                const deleteEvent = (id) => {
                    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚')) {
                        events.value = events.value.filter(e => e.id !== id);
                        closeModal();
                    }
                };

                const toggleThemeModal = () => {
                    showThemeModal.value = !showThemeModal.value;
                };

                const toggleSettingsModal = () => {
                    showSettingsModal.value = !showSettingsModal.value;
                };

                const toggleImportModal = () => {
                    showImportModal.value = !showImportModal.value;
                    importJson.value = '';
                };

                const setTheme = (color) => {
                    themeColor.value = color;
                    if (form.customTheme) {
                        form.customTheme = color;
                    }
                    toggleThemeModal();
                };

                const updateCustomTheme = () => {
                    themeColor.value = form.customTheme;
                };

                const processImport = () => {
                    try {
                        const importedData = JSON.parse(importJson.value);
                        if (Array.isArray(importedData)) {
                            // æª¢æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„äº‹ä»¶é™£åˆ—
                            if (importedData.every(item => item.title && item.date)) {
                                events.value = importedData.map(event => ({
                                    ...event,
                                    // ç¢ºä¿ ticket çµæ§‹çš„å®Œæ•´æ€§
                                    ticket: event.ticket || { hasTicket: false, totalExpense: 0, seatInfo: '', expenses: [], checklist: [] },
                                }));
                                alert('è³‡æ–™é‚„åŸæˆåŠŸï¼');
                                toggleImportModal();
                                toggleSettingsModal();
                                return;
                            }
                        }
                        
                        // å˜—è©¦é‚„åŸè¨­å®š
                        if (importedData.themeColor) {
                            themeColor.value = importedData.themeColor;
                            isPrivacyMode.value = importedData.isPrivacyMode;
                            customTitle.value = importedData.customTitle;
                            alert('è¨­å®šé‚„åŸæˆåŠŸï¼');
                            toggleImportModal();
                            toggleSettingsModal();
                            return;
                        }

                        alert('è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªè²¼ä¸Šçš„æ˜¯æ­£ç¢ºçš„ JSON å‚™ä»½æª”æ¡ˆã€‚');

                    } catch (e) {
                        alert('è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªè²¼ä¸Šçš„æ˜¯ JSON æ–‡æœ¬ã€‚');
                        console.error(e);
                    }
                };

                const toggleExpand = (id) => {
                    expandedEventId.value = expandedEventId.value === id ? null : id;
                };
                
                const togglePrivacy = () => {
                    // Privacy mode is automatically updated by watcher
                };

                // è²»ç”¨/å¾…è¾¦æ¸…å–®æ–¹æ³•
                const calculateTotal = (items) => {
                    return items.reduce((sum, item) => sum + (item.amount || 0), 0);
                };

                const addExpenseItem = () => {
                    form.ticket.expenses.push({ name: '', amount: 0 });
                };

                const removeExpenseItem = (index) => {
                    form.ticket.expenses.splice(index, 1);
                };

                const addChecklistItem = () => {
                    form.ticket.checklist.push({ task: '', checked: false });
                };
                
                const addDefaultChecklist = () => {
                    const currentTasks = form.ticket.checklist.map(item => item.task);
                    defaultChecklistItems.forEach(task => {
                        if (!currentTasks.includes(task)) {
                            form.ticket.checklist.push({ task: task, checked: false });
                        }
                    });
                };

                const removeChecklistItem = (index) => {
                    form.ticket.checklist.splice(index, 1);
                };
                
                const saveChecklistState = (id) => {
                    // ç¢ºä¿ç‹€æ…‹åœ¨ local storage ä¸­æ›´æ–°
                    if (id) {
                        const event = events.value.find(e => e.id === id);
                        if (event) {
                            event.ticket.checklist = JSON.parse(JSON.stringify(form.ticket.checklist));
                        }
                    }
                };
                
                const getEventColor = (event) => {
                    const artistHash = event.artist ? event.artist.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) : 0;
                    const index = artistHash % presetColors.length;
                    return presetColors[index].hex;
                };
                
                const downloadBackup = () => {
                    const data = JSON.stringify(events.value);
                    const settings = JSON.stringify({
                        themeColor: themeColor.value,
                        isPrivacyMode: isPrivacyMode.value,
                        customTitle: customTitle.value,
                    });
                    const content = JSON.stringify({ events: data, settings: settings }); // çµåˆç‚ºä¸€å€‹æª”æ¡ˆæˆ–åˆ†åˆ¥ä¸‹è¼‰

                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `star_diary_backup_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert('å‚™ä»½æª”æ¡ˆå·²ä¸‹è¼‰ï¼');
                };

                const restoreBackup = () => {
                    toggleImportModal();
                };
                
                const idolNagging = computed(() => {
                    const today = new Date().toISOString().split('T')[0];
                    const upcomingEvents = events.value.filter(e => e.date >= today);
                    if (upcomingEvents.length === 0) {
                        return 'å¥½å®‰éœ... é›£é“æœ€è¿‘æ²’æœ‰æ–°æ´»å‹•äº†å—ï¼Ÿ';
                    }
                    
                    const nextEvent = upcomingEvents.sort((a, b) => new Date(a.date) - new Date(b.date))[0];
                    const diff = getDaysDiff(nextEvent.date);
                    
                    if (diff === 0) {
                        return `ä»Šå¤©å°±æ˜¯ ${nextEvent.artist} çš„ ${nextEvent.title}ï¼å¿«å»å—¨ï¼`;
                    }
                    if (diff === 1) {
                        return `æ˜å¤©å°±æ˜¯ ${nextEvent.title}ï¼å¾…è¾¦æ¸…å–®éƒ½ç¢ºèªäº†å—ï¼Ÿ`;
                    }
                    if (diff > 1 && diff <= 7) {
                        return `è·é›¢ ${nextEvent.artist} çš„ ${nextEvent.title} é‚„æœ‰ ${diff} å¤©ï¼æœŸå¾…å—ï¼Ÿ`;
                    }
                    
                    return '';
                });

                const searchCoordinates = async () => {
                    isSearching.value = true;
                    searchError.value = '';
                    let mappedCount = 0;

                    for (const event of events.value) {
                        if (event.location && !event.coordinates) {
                            try {
                                // æ¨¡æ“¬ Google Maps Geocoding API æŸ¥è©¢
                                // æ³¨æ„: åœ¨çœŸå¯¦æ‡‰ç”¨ä¸­ï¼Œä½ éœ€è¦ä½¿ç”¨åˆæ³•çš„ API Key å‘¼å« Google Maps Geocoding API
                                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(event.location)}&format=json&limit=1`);
                                const data = await response.json();
                                
                                if (data && data.length > 0) {
                                    event.coordinates = `${data[0].lat}, ${data[0].lon}`;
                                    mappedCount++;
                                    // ç¢ºä¿æ¯æ¬¡æ›´æ–°éƒ½æœƒè§¸ç™¼ storage å„²å­˜
                                    localStorage.setItem(EVENTS_KEY, JSON.stringify(events.value));
                                } else {
                                    console.log(`æ‰¾ä¸åˆ°åœ°é»åº§æ¨™: ${event.location}`);
                                }
                            } catch (e) {
                                searchError.value = 'åº§æ¨™æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                                console.error('Geocoding Error:', e);
                                break;
                            }
                        }
                    }

                    isSearching.value = false;
                    if (!searchError.value) {
                        alert(`åº§æ¨™æœå°‹å®Œæˆï¼æˆåŠŸæ‰¾åˆ° ${mappedCount} å€‹æ–°åœ°é»ã€‚`);
                    }
                };
                
                const showTicket = (event) => {
                    ticketEvent.value = event;
                    showTicketModal.value = true;
                };

                const getTicketPrice = (event) => {
                    if (event.ticket.hasTicket) {
                        return event.ticket.totalExpense;
                    }
                    return 0;
                };

                // Helper Functions
                const formatMoney = (v) => v ? v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0';
                const getDay = (d) => new Date(d).getDate();
                const getMonth = (d) => ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"][new Date(d).getMonth()];
                const getDaysDiff = (d) => Math.ceil((new Date(d).setHours(0,0,0,0) - new Date().setHours(0,0,0,0))/(1000*60*60*24));
                
                // [ä¿®æ­£] Google Maps æœå°‹é€£çµï¼šä½¿ç”¨æ›´å¯é çš„ Google Maps æœå°‹ API æ ¼å¼
                const getMapLink = (l) => l ?
                    `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l)}` : '#';

                // [æ–°å¢åŠŸèƒ½] ç”¢ç”Ÿ Google æ—¥æ›†æ–°å¢äº‹ä»¶é€£çµ
                const getGoogleCalendarLink = (event) => {
                    const { title, date, time, location, artist, memo } = event;
                    const start = `${date.replace(/-/g, '')}T${time.replace(/:/g, '')}00`;
                    // é è¨­æ´»å‹•é•·åº¦ç‚º 3 å°æ™‚
                    const endDate = new Date(new Date(`${date}T${time}`).getTime() + 3*60*60*1000);
                    const end = `${endDate.toISOString().split('T')[0].replace(/-/g, '')}T${endDate.toTimeString().split(' ')[0].replace(/:/g, '')}00`;

                    // %0A æ˜¯æ›è¡Œç¬¦
                    const details = `æ´»å‹•ï¼š${title}%0Aè—äººï¼š${artist}%0Aåœ°é»ï¼š${location}%0Aç­†è¨˜ï¼š${memo || 'ç„¡å¿ƒå¾—ç­†è¨˜'}`;

                    return `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}%20(%20${artist}%20)&dates=${start}/${end}&details=${details}&location=${encodeURIComponent(location)}&sf=true&output=xml`;
                };

                // åˆå§‹åŒ–
                onMounted(() => {
                    loadData();
                    updateAppTitle();
                });

                return {
                    events, activeTab, viewMode, themeColor, selectedYear, expandedEventId, isPrivacyMode, customTitle,
                    showModal, showSettingsModal, showImportModal, showTicketModal, showThemeModal, ticketEvent, isEditing, form, importJson, searchQuery,
                    cssVars, greetingMessage, filteredEvents, upcomingCount, currentYearExpense, statsData, presetColors, moodStickers,
                    openModal, editEvent, closeModal, saveEvent, deleteEvent, toggleThemeModal, toggleSettingsModal, setTheme, updateCustomTheme, processImport, 
                    toggleExpand, togglePrivacy, formatMoney, getDay, getMonth, getDaysDiff, getMapLink, getGoogleCalendarLink, // <--- æ–°å¢ getGoogleCalendarLink
                    calculateTotal, addExpenseItem, removeExpenseItem, addChecklistItem, removeChecklistItem, addDefaultChecklist, saveChecklistState,
                    getEventColor, emotionalSummary, availableYears, searchCoordinates, isSearching, searchError, mappedEventsCount, missingCoordsCount,
                    downloadBackup, restoreBackup, idolNagging, addToCalendar: () => {}, // ç°¡å–®ä¿ç•™ï¼ŒåŸ addToCalendar å¯¦ä½œå·²åœ¨ä¸Šæ–¹
                    showTicket, getTicketPrice, updateAppTitle
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
