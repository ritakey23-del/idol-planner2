<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¿½æ˜Ÿè¦åŠƒä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <style>
        /* å®šç¾© CSS è®Šæ•¸ä¾› Tailwind å‹•æ…‹ä¸»é¡Œä½¿ç”¨ */
        :root {
            --theme-hex: #4FBDBA; 
            --theme-rgb: 79, 189, 186; 
        }
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿æŒåŠŸèƒ½ (Optional) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // å‹•æ…‹æ³¨å…¥ä¸»é¡Œè‰²
                        'app-theme': {
                            50: 'rgba(var(--theme-rgb), 0.05)',
                            100: 'rgba(var(--theme-rgb), 0.1)',
                            200: 'rgba(var(--theme-rgb), 0.2)',
                            300: 'rgba(var(--theme-rgb), 0.4)',
                            400: 'rgba(var(--theme-rgb), 0.6)', 
                            500: 'rgba(var(--theme-rgb), 0.8)', // ä¸»è¦æŒ‰éˆ•/å°èˆª
                            600: 'rgba(var(--theme-rgb), 0.9)',
                            700: 'var(--theme-hex)', // ä¸»è¦æ–‡å­—
                            800: 'var(--theme-hex)', 
                        },
                        // æ‡‰æ´è‰²æ¨™æº–è‰²ç¥¨
                        'aquamarine': { 400: '#4FBDBA', 500: '#349996', 100: '#d9fffd', 700: '#235c59', 800: '#1b3d3c', 50: '#f0fffe' },
                        'emerald': { 400: '#34D399', 500: '#10B981', 600: '#059669' },
                        'fuchsia': { 500: '#A855F7' },
                        'purple': { 500: '#8B5CF6' },
                        'red': { 500: '#EF4444' },
                        'sky': { 400: '#38BDF8' },
                        'cyan': { 500: '#06B6D4' },
                        'gray': { 300: '#D1D5DB' },
                        'yellow': { 400: '#FDE047' },
                        'lime': { 500: '#84CC16' },
                        'green': { 500: '#22C55E' },
                        'blue': { 500: '#3B82F6' },
                        'amber': { 400: '#FBBF24' },
                        'pink': { 500: '#EC4899' },
                        'orange': { 500: '#F97316' },
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen font-sans flex justify-center text-gray-800">

    <div id="app" class="w-full max-w-md bg-white shadow-2xl min-h-screen flex flex-col relative">

        <header class="bg-app-theme-500 text-white p-4 shadow-lg sticky top-0 z-30 transition-colors duration-300">
            <div class="flex justify-between items-center">
                <button v-if="currentEvent" @click="goToEventList"
                        class="text-white p-1 rounded-full transition duration-150 transform hover:scale-110 active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div v-else class="w-8"></div> <h1 class="text-lg font-bold truncate px-2">
                    {{ currentEvent ? currentEvent.eventName : 'è¿½æ˜Ÿè¦åŠƒä¸­å¿ƒ' }}
                </h1>
                
                <div class="flex space-x-2">
                    <button @click="showColorModal = true"
                            class="text-white p-1.5 rounded-full hover:bg-white/20 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm12 12H4l4-4 4 4 4-4V4z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <button @click="showImportModal = true"
                            class="text-white p-1.5 rounded-full hover:bg-white/20 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.293a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <button @click="showEventModal = true"
                            class="text-white p-1.5 rounded-full hover:bg-white/20 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>

            <div v-if="currentEvent" class="mt-1 text-center text-xs opacity-90">
                <p>{{ currentEvent.artistName }} | {{ currentEvent.date }}</p>
            </div>
        </header>

        <main class="flex-grow p-4 overflow-y-auto no-scrollbar pb-24">
            
            <div v-if="loading || !isAuthReady" class="flex flex-col items-center justify-center h-64 text-gray-500">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-app-theme-500 mb-3"></div>
                <p>æ­£åœ¨é€£æ¥è³‡æ–™åº«...</p>
            </div>

            <div v-else>
                
                <div v-if="activeTab === 'review'" class="animate-fade-in">
                    <h2 class="text-xl font-bold text-app-theme-700 mb-4">âœ¨ è¿½æ˜Ÿå¹´å ±</h2>

                    <div class="mb-4 bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                        <label for="year-select" class="text-sm font-medium text-gray-600">é¸æ“‡å¹´åº¦:</label>
                        <select id="year-select" v-model="selectedReviewYear"
                                class="p-2 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:outline-none focus:border-app-theme-400">
                            <option value="all">ç¸½å¹´åº¦</option>
                            <option v-for="year in eventYears" :key="year" :value="year">{{ year }} å¹´</option>
                        </select>
                    </div>

                    <div class="p-4 rounded-xl shadow-lg mb-6 bg-gradient-to-r from-app-theme-50 to-white border border-app-theme-200">
                        <h3 class="text-lg font-bold text-app-theme-800 flex items-center mb-2">
                            <span class="mr-2">ğŸ’°</span> æ‡‰æ´å¶åƒèŠ±äº†
                        </h3>
                        <div class="space-y-1">
                            <p class="text-sm text-gray-600">ç¸½è¨ˆèŠ±è²»</p>
                            <p class="text-3xl font-extrabold text-red-500 tracking-tight">NT$ {{ overallStats.totalExpense }}</p>
                            <p class="text-xs text-gray-400 mt-1">å¹³å‡æ¯å ´æˆæœ¬ï¼šNT$ {{ overallStats.avgExpensePerEvent }}</p>
                        </div>
                    </div>

                    <div class="p-4 rounded-xl shadow-lg mb-6 bg-white border-l-4 border-app-theme-400">
                        <h3 class="text-lg font-bold text-app-theme-800 mb-3 flex items-center">
                            <span class="mr-2">ğŸŒŸ</span> {{ selectedReviewYear === 'all' ? 'ç”Ÿæ¶¯æˆå°±' : selectedReviewYear + ' å¹´åº¦æˆå°±' }}
                        </h3>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-gray-50 p-3 rounded-lg text-center">
                                <p class="text-2xl font-bold text-app-theme-600">{{ overallStats.totalEventsAll }}</p>
                                <p class="text-xs text-gray-500">ç¸½æ´»å‹•å ´æ¬¡</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg text-center">
                                <p class="text-2xl font-bold text-app-theme-600">{{ overallStats.uniqueArtists }}</p>
                                <p class="text-xs text-gray-500">è§£é–è—äººçµ„æ•¸</p>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <button @click="showExclusionDisclaimer = !showExclusionDisclaimer" 
                                    class="text-xs text-app-theme-500 hover:text-app-theme-700 underline flex items-center">
                                <span class="mr-1">{{ showExclusionDisclaimer ? 'â–²' : 'â–¼' }}</span> é—œæ–¼çµ±è¨ˆæ’é™¤è¦å‰‡
                            </button>
                            <p v-if="showExclusionDisclaimer" class="text-xs text-gray-500 mt-2 p-2 bg-gray-50 rounded border border-gray-100">
                                æ’è¡Œæ¦œçµ±è¨ˆå·²æ’é™¤åç¨±å«ã€Œäº‹å‰éŒ„è£½ã€ã€ã€Œç°½å”®æœƒã€ç­‰éå¤§å‹å…¬æ¼”æ´»å‹•ã€‚
                            </p>
                        </div>

                        <div v-if="overallStats.artistBreakdown.length > 0">
                            <h4 class="font-bold text-gray-700 text-sm mb-2">ğŸ¥‡ è¦‹é¢æ¬¡æ•¸æ’è¡Œ</h4>
                            <ul class="text-sm space-y-2">
                                <li v-for="(item, index) in overallStats.artistBreakdown.slice(0, 5)" :key="item.name" 
                                    class="flex justify-between items-center p-2 rounded hover:bg-gray-50 transition">
                                    <span class="font-medium flex items-center">
                                        <span class="w-6 text-center mr-2 font-bold" :class="index < 3 ? 'text-yellow-500' : 'text-gray-400'">{{ index + 1 }}</span>
                                        {{ item.name }}
                                    </span>
                                    <span class="bg-app-theme-100 text-app-theme-800 px-2 py-0.5 rounded-full text-xs font-bold">{{ item.count }} æ¬¡</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <h3 class="text-lg font-bold text-gray-700 mb-3">ğŸ“œ æ´»å‹•å±¥æ­·</h3>
                    <div v-if="eventsInSelectedScope.length > 0" class="space-y-3">
                            <div v-for="event in eventsInSelectedScope" :key="event.id"
                                @click="setActiveEvent(event.id); setActiveTab('info')"
                                class="p-4 bg-white shadow-sm rounded-xl border-l-4 transition transform active:scale-98"
                                :class="event.date >= today ? getFanColorClass(event.artistName) : 'border-gray-300 opacity-80'">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-gray-800 text-lg">{{ event.eventName }}</p>
                                    <p class="text-sm text-gray-600">{{ event.artistName }}</p>
                                </div>
                                <span class="text-xs font-mono bg-gray-100 px-2 py-1 rounded text-gray-500">{{ event.date }}</span>
                            </div>
                        </div>
                    </div>
                    <div v-else class="text-center p-8 text-gray-400 border-2 border-dashed border-gray-200 rounded-xl">
                        ç„¡è¡Œç¨‹ç´€éŒ„
                    </div>
                </div>
                
                <div v-else-if="activeTab === 'expense'" class="animate-fade-in">
                    <h2 class="text-xl font-bold text-app-theme-700 mb-4">è¨˜å¸³æœ¬</h2>
                    
                    <div v-if="!currentEvent" class="flex flex-col items-center justify-center p-8 bg-white rounded-xl shadow border border-gray-100 text-center h-64">
                        <div class="text-4xl mb-3">ğŸ’¸</div>
                        <p class="text-lg font-bold text-gray-700 mb-1">è«‹å…ˆé¸æ“‡æ´»å‹•</p>
                        <p class="text-sm text-gray-500">éœ€æŒ‡å®šä¸€å€‹è¡Œç¨‹æ‰èƒ½é–‹å§‹è¨˜å¸³</p>
                        <button @click="goToEventList" class="mt-4 px-4 py-2 bg-app-theme-500 text-white rounded-lg text-sm">å‰å¾€é¸æ“‡</button>
                    </div>
                    
                    <div v-else>
                        <div class="p-5 rounded-xl shadow-lg mb-6 bg-gradient-to-br from-app-theme-500 to-app-theme-600 text-white">
                            <p class="text-sm opacity-80">æœ¬å ´æ´»å‹•ç¸½æ”¯å‡º</p>
                            <p class="text-3xl font-bold mt-1">NT$ {{ expenseSummary.totalSpent }}</p>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                            <div v-if="currentEvent.expenses && currentEvent.expenses.length > 0">
                                <div v-for="exp in currentEvent.expenses" :key="exp.id"
                                    class="flex justify-between items-center p-4 border-b border-gray-100 last:border-0 hover:bg-gray-50">
                                    <div>
                                        <p class="font-bold text-gray-800">{{ exp.description }}</p>
                                        <p class="text-xs text-gray-400">è‡ªå·±æ”¯ä»˜</p>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="font-bold text-red-500 mr-3">-{{ exp.amount }}</span>
                                        <button @click="deleteExpense(exp.id)" class="text-gray-300 hover:text-red-500">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="p-6 text-center text-gray-400 text-sm">
                                å°šæœªæ–°å¢ä»»ä½•æ”¯å‡º
                            </div>
                        </div>

                        <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                            <h3 class="text-sm font-bold text-gray-600 mb-3 uppercase tracking-wide">æ–°å¢ä¸€ç­†</h3>
                            <div class="flex flex-col space-y-3">
                                <input type="text" v-model="newExpense.description" placeholder="é …ç›® (å¦‚ï¼šé–€ç¥¨)"
                                    class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-app-theme-400 focus:outline-none">
                                <div class="flex space-x-2">
                                    <span class="flex items-center justify-center px-3 bg-gray-200 rounded-lg text-gray-600">NT$</span>
                                    <input type="number" v-model.number="newExpense.amount" placeholder="0"
                                        class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-app-theme-400 focus:outline-none">
                                </div>
                                <button @click="addExpense"
                                        :disabled="newExpense.amount <= 0 || !newExpense.description"
                                        class="w-full bg-app-theme-500 hover:bg-app-theme-600 text-white font-bold py-3 rounded-lg transition shadow-md disabled:opacity-50 disabled:shadow-none">
                                    åŠ å…¥è¨˜å¸³
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else class="animate-fade-in"> 
                    
                    <div v-if="currentEvent">
                        <div v-if="activeTab === 'info'" class="space-y-4">
                            
                            <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-app-theme-500 text-center relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-2 opacity-10">
                                    <svg class="w-24 h-24 text-app-theme-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                </div>
                                <h2 class="text-3xl font-black text-gray-800 mb-1">{{ currentEvent.date }}</h2>
                                <p class="text-gray-500 font-medium mb-4">{{ currentEvent.mainLocation || 'åœ°é»æœªå®š' }}</p>
                                <div class="inline-block px-3 py-1 rounded-full bg-app-theme-100 text-app-theme-700 text-sm font-bold mb-6">
                                    {{ currentEvent.artistName }}
                                </div>

                                <div class="grid grid-cols-2 gap-2 border-t border-gray-100 pt-4 text-left text-sm">
                                    <div>
                                        <p class="text-gray-400 text-xs">åŒè¡Œå¤¥ä¼´</p>
                                        <p class="font-medium text-gray-700 truncate">{{ currentEvent.participants ? currentEvent.participants.join(', ') : 'ç„¡' }}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400 text-xs">å¹´åº¦</p>
                                        <p class="font-medium text-gray-700">{{ currentEvent.year }}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <button @click="loadEditForm"
                                        class="flex items-center justify-center py-3 bg-white border border-gray-200 rounded-xl text-gray-700 font-bold hover:bg-gray-50 transition shadow-sm">
                                    âœï¸ ç·¨è¼¯è³‡æ–™
                                </button>
                                <button @click="deleteEvent(currentEvent.id)"
                                        class="flex items-center justify-center py-3 bg-white border border-red-100 text-red-500 rounded-xl font-bold hover:bg-red-50 transition shadow-sm">
                                    ğŸ—‘ï¸ åˆªé™¤è¡Œç¨‹
                                </button>
                            </div>

                            <button @click="setActiveTab('schedule')"
                                    class="w-full bg-app-theme-500 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-app-theme-600 transition transform active:scale-98 flex justify-center items-center">
                                æŸ¥çœ‹æ¯æ—¥è¡Œç¨‹è¡¨
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                            </button>
                        </div>
                        
                        <div v-else-if="activeTab === 'schedule'">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-gray-800">æ¯æ—¥æµç¨‹</h2>
                                <button onclick="document.getElementById('dailyItemModal').classList.remove('hidden')" 
                                        class="text-sm bg-app-theme-100 text-app-theme-700 px-3 py-1 rounded-full font-bold">
                                    + æ–°å¢
                                </button>
                            </div>

                            <a v-if="mapLink" :href="mapLink.url" target="_blank"
                               class="block mb-4 p-3 bg-blue-50 text-blue-600 rounded-xl border border-blue-100 text-center text-sm font-bold hover:bg-blue-100 transition">
                                ğŸ—ºï¸ é–‹å•Ÿ Google Maps å°èˆª
                            </a>

                            <div v-if="currentEvent.dailyItems && currentEvent.dailyItems.length > 0" class="space-y-4 relative pl-2">
                                <div class="absolute left-6 top-2 bottom-2 w-0.5 bg-gray-200"></div>

                                <div v-for="item in currentEvent.dailyItems" :key="item.id"
                                     class="relative flex items-start group">
                                    <div class="absolute left-0 w-12 text-center">
                                        <div class="bg-white border-2 border-app-theme-400 text-gray-700 text-xs font-bold rounded-full py-1 px-1 z-10 relative">
                                            {{ item.time }}
                                        </div>
                                    </div>
                                    <div class="ml-14 bg-white p-3 rounded-xl shadow-sm border border-gray-100 w-full hover:shadow-md transition">
                                        <div class="flex justify-between items-start">
                                            <h3 class="font-bold text-gray-800 text-sm">{{ item.location }}</h3>
                                            <button @click="deleteDailyItem(item.id)" class="text-gray-300 hover:text-red-400">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                            </button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">{{ item.description }}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div v-else class="text-center py-10">
                                <p class="text-gray-400 mb-2">å°šæœªå®‰æ’è¡Œç¨‹ç´°ç¯€</p>
                                <button onclick="document.getElementById('dailyItemModal').classList.remove('hidden')" 
                                        class="text-app-theme-500 font-bold text-sm hover:underline">
                                    ç«‹å³è¦åŠƒ
                                </button>
                            </div>
                        </div>
                    </div>

                    <div v-else class="space-y-6">
                        <div>
                            <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                                <span class="bg-app-theme-100 text-app-theme-600 p-1 rounded mr-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                </span>
                                å³å°‡å‡ºç™¼
                            </h2>
                            <div v-if="upcomingEvents.length > 0" class="space-y-3">
                                <div v-for="event in upcomingEvents" :key="event.id"
                                     @click="setActiveEvent(event.id)"
                                     class="bg-white p-4 rounded-xl shadow-md border-l-4 transition transform active:scale-98 cursor-pointer flex justify-between items-center"
                                     :class="getFanColorClass(event.artistName)">
                                    <div>
                                        <p class="font-bold text-gray-800">{{ event.eventName }}</p>
                                        <p class="text-xs text-gray-500 font-medium mt-1">{{ event.date }} â€¢ {{ event.artistName }}</p>
                                    </div>
                                    <div class="text-gray-300">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="bg-gray-50 border border-dashed border-gray-300 rounded-xl p-4 text-center text-sm text-gray-500">
                                æœ€è¿‘æ²’æœ‰å®‰æ’è¡Œç¨‹ï¼Œå¿«å»è²·ç¥¨å§ï¼ğŸ«
                            </div>
                        </div>

                        <div>
                            <h2 class="text-lg font-bold text-gray-600 mb-3 flex items-center opacity-80">
                                <span class="bg-gray-100 text-gray-500 p-1 rounded mr-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </span>
                                ç¾å¥½å›æ†¶
                            </h2>
                            <div v-if="pastEvents.length > 0" class="space-y-3">
                                <div v-for="event in pastEvents" :key="event.id"
                                     @click="setActiveEvent(event.id)"
                                     class="bg-gray-50 p-4 rounded-xl border border-gray-100 transition transform active:scale-98 cursor-pointer opacity-80 hover:opacity-100">
                                    <p class="font-bold text-gray-700">{{ event.eventName }}</p>
                                    <p class="text-xs text-gray-500 mt-1">{{ event.date }} â€¢ {{ event.artistName }}</p>
                                </div>
                            </div>
                            <div v-else class="text-center text-xs text-gray-400 py-2">
                                å°šç„¡æ­·å²ç´€éŒ„
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <nav class="bg-white border-t border-gray-100 sticky bottom-0 z-40 pb-safe">
            <div class="flex justify-around items-center h-16">
                <button @click="goToEventList()"
                        class="flex flex-col items-center justify-center w-full h-full transition duration-200"
                        :class="activeTab === 'schedule' || activeTab === 'info' ? 'text-app-theme-600' : 'text-gray-400 hover:text-gray-600'">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 4h-1V3a1 1 0 00-2 0v1H8V3a1 1 0 00-2 0v1H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2zm0 16H5V9h14v11z"></path></svg>
                    <span class="text-[10px] font-bold">è¡Œç¨‹</span>
                </button>
                <button @click="setActiveTab('review')"
                        class="flex flex-col items-center justify-center w-full h-full transition duration-200"
                        :class="activeTab === 'review' ? 'text-app-theme-600' : 'text-gray-400 hover:text-gray-600'">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    <span class="text-[10px] font-bold">å›é¡§</span>
                </button>
                <button @click="setActiveTab('expense')"
                        class="flex flex-col items-center justify-center w-full h-full transition duration-200"
                        :class="activeTab === 'expense' ? 'text-app-theme-600' : 'text-gray-400 hover:text-gray-600'">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="text-[10px] font-bold">è¨˜å¸³</span>
                </button>
            </div>
        </nav>

        <div v-if="showEventModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center z-50 animate-fade-in">
            <div class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl transform transition-all">
                <h3 class="text-xl font-bold text-gray-800 mb-4">æ–°å¢è¡Œç¨‹</h3>
                <div class="space-y-4">
                    <input type="text" v-model="newEventName" placeholder="æ´»å‹•åç¨±" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:bg-white focus:ring-2 focus:ring-app-theme-400 outline-none">
                    <input type="text" v-model="newArtistName" placeholder="æ­Œæ‰‹/è—äºº" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:bg-white focus:ring-2 focus:ring-app-theme-400 outline-none">
                    <div>
                        <label class="text-xs text-gray-500 ml-1">æ—¥æœŸ</label>
                        <input type="date" v-model="newEventDate" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:bg-white focus:ring-2 focus:ring-app-theme-400 outline-none">
                    </div>
                    <input type="text" v-model="newEventLocation" placeholder="åœ°é»" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:bg-white focus:ring-2 focus:ring-app-theme-400 outline-none">
                    
                    <button @click="addEvent" :disabled="!newEventName || !newEventDate" class="w-full bg-app-theme-500 text-white font-bold py-3 rounded-xl shadow hover:bg-app-theme-600 disabled:opacity-50">å»ºç«‹è¡Œç¨‹</button>
                    <button @click="showEventModal = false" class="w-full text-gray-500 font-bold py-2 hover:text-gray-800">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <div v-if="showImportModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                <h3 class="text-lg font-bold text-gray-800 mb-2">CSV æ‰¹æ¬¡åŒ¯å…¥</h3>
                <p class="text-xs text-gray-500 mb-4">è«‹ä¸Šå‚³åŒ…å«ï¼šæ—¥æœŸ(YYMMDD), æ­Œæ‰‹, æ´»å‹•åç¨±, åœ°é» çš„ CSV æª”æ¡ˆã€‚</p>
                
                <div class="border-2 border-dashed border-gray-200 rounded-xl p-6 text-center hover:bg-gray-50 transition cursor-pointer relative">
                    <input type="file" @change="handleFileSelect" accept=".csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" :disabled="isImporting">
                    <div v-if="!selectedFile" class="text-gray-400">
                        <p class="text-2xl mb-2">ğŸ“„</p>
                        <p class="text-sm">é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                    </div>
                    <div v-else class="text-app-theme-600 font-bold">
                        {{ selectedFile.name }}
                    </div>
                </div>

                <div class="mt-4 space-y-2">
                    <button @click="importCSV" :disabled="!selectedFile || isImporting" class="w-full bg-app-theme-500 text-white font-bold py-3 rounded-xl disabled:opacity-50 flex justify-center items-center">
                         <span v-if="isImporting" class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></span>
                         {{ isImporting ? 'è™•ç†ä¸­...' : 'é–‹å§‹åŒ¯å…¥' }}
                    </button>
                    <button @click="showImportModal = false" class="w-full text-gray-500 font-bold py-2">é—œé–‰</button>
                </div>
            </div>
        </div>

        <div v-if="showEditModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center z-50">
            <div class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl">
                <h3 class="text-lg font-bold text-gray-800 mb-4">ç·¨è¼¯è¡Œç¨‹</h3>
                <div class="space-y-3">
                    <input type="text" v-model="editEventForm.eventName" class="w-full p-3 bg-gray-50 border rounded-xl">
                    <input type="text" v-model="editEventForm.artistName" class="w-full p-3 bg-gray-50 border rounded-xl">
                    <input type="date" v-model="editEventForm.date" class="w-full p-3 bg-gray-50 border rounded-xl">
                    <input type="text" v-model="editEventForm.mainLocation" class="w-full p-3 bg-gray-50 border rounded-xl">
                    <button @click="saveEditedEvent" class="w-full bg-app-theme-500 text-white font-bold py-3 rounded-xl mt-2">å„²å­˜</button>
                    <button @click="showEditModal = false" class="w-full text-gray-500 font-bold py-2">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <div id="dailyItemModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center z-50">
             <div class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up">
                <h3 class="text-lg font-bold text-gray-800 mb-4">æ–°å¢æ™‚é–“é»</h3>
                <div class="space-y-3">
                    <input type="time" v-model="newSchedule.time" class="w-full p-3 bg-gray-50 border rounded-xl text-lg">
                    <input type="text" v-model="newSchedule.location" placeholder="åšä»€éº¼/åœ¨å“ªè£¡" class="w-full p-3 bg-gray-50 border rounded-xl">
                    <input type="text" v-model="newSchedule.description" placeholder="å‚™è¨»" class="w-full p-3 bg-gray-50 border rounded-xl">
                    
                    <button @click="addDailyItem(); document.getElementById('dailyItemModal').classList.add('hidden')" 
                            class="w-full bg-app-theme-500 text-white font-bold py-3 rounded-xl">æ–°å¢</button>
                    <button @click="document.getElementById('dailyItemModal').classList.add('hidden')" 
                            class="w-full text-gray-500 font-bold py-2">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <div v-if="showColorModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
             <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl max-h-[85vh] overflow-y-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ¨ App è¨­å®š</h2>
                
                <div class="mb-6">
                    <h3 class="text-sm font-bold text-gray-500 mb-2 uppercase">å…¨åŸŸä¸»é¡Œè‰²</h3>
                    <div class="flex space-x-2 mb-3">
                         <input type="text" v-model="newThemeSelectionHex" placeholder="#4FBDBA"
                                class="flex-grow p-2 border rounded-lg uppercase font-mono text-sm">
                         <div class="w-10 h-10 rounded-lg border shadow-sm" :style="{ backgroundColor: newThemeSelectionHex }"></div>
                    </div>
                    <button @click="saveAppTheme" class="w-full bg-gray-800 text-white text-sm font-bold py-2 rounded-lg">æ‡‰ç”¨ä¸»é¡Œ</button>
                </div>

                <div class="mb-4">
                     <h3 class="text-sm font-bold text-gray-500 mb-2 uppercase">æ­Œæ‰‹æ‡‰æ´è‰² (Tailwind)</h3>
                     <div class="bg-gray-50 rounded-xl p-3 max-h-40 overflow-y-auto mb-3 space-y-2">
                        <div v-for="(color, artist) in fanColors" :key="artist"
                             class="flex justify-between items-center text-sm p-2 bg-white rounded shadow-sm border-l-4"
                             :class="getFanColorClass(artist)">
                            <span>{{ artist }}</span>
                            <button @click="deleteColor(artist)" class="text-red-400 font-bold px-2">Ã—</button>
                        </div>
                     </div>
                     <div class="space-y-2">
                         <input type="text" v-model="newColorArtist" placeholder="æ­Œæ‰‹ (å¦‚: Key)" class="w-full p-2 border rounded text-sm">
                         <input type="text" v-model="newColorClass" placeholder="è‰²ç¢¼ (å¦‚: aquamarine-500)" class="w-full p-2 border rounded text-sm">
                         <button @click="addOrUpdateColor" class="w-full bg-gray-200 text-gray-700 font-bold py-2 rounded-lg text-sm hover:bg-gray-300">æ–°å¢/æ›´æ–°</button>
                     </div>
                </div>

                <button @click="showColorModal = false" class="w-full text-red-500 font-bold py-3 mt-4 border-t border-gray-100">é—œé–‰è¨­å®š</button>
             </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // CONFIGURATION AREA (USER TO REPLACE)
        // è«‹å°‡ä¸‹æ–¹çš„é…ç½®æ›¿æ›ç‚ºæ‚¨çš„ Firebase å°ˆæ¡ˆè¨­å®š
        // ==========================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.firebasestorage.app",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const appId = 'my-fan-planner'; // å¯è‡ªå®šç¾© ID
        // ==========================================

        let app, db, auth;
        let unsubscribeEvents = null;
        let unsubscribeColors = null;
        let unsubscribeTheme = null;

        const { createApp, ref, computed } = Vue;

        // é è¨­èˆ‡è¼”åŠ©å‡½æ•¸
        const DEFAULT_COLOR_CLASS = 'border-blue-500';
        const INITIAL_APP_THEME_HEX = '#4FBDBA';

        const hexToRgb = (hex) => {
            const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b);
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [
                parseInt(result[1], 16),
                parseInt(result[2], 16),
                parseInt(result[3], 16)
            ] : [79, 189, 186];
        };

        const EventTracker = {
            setup() {
                // State
                const isAuthReady = ref(false);
                const userId = ref(null);
                const loading = ref(true);
                const events = ref([]);
                const activeEventId = ref(null);
                const activeTab = ref('schedule'); 
                const selectedReviewYear = ref('all'); 
                const showExclusionDisclaimer = ref(false);
                
                // Theme & Color
                const currentAppThemeHex = ref(INITIAL_APP_THEME_HEX);
                const newThemeSelectionHex = ref(INITIAL_APP_THEME_HEX);
                const fanColors = ref({}); 
                const showColorModal = ref(false);
                const newColorArtist = ref('');
                const newColorClass = ref('aquamarine-400');

                // Forms
                const newEventName = ref('');
                const newArtistName = ref('');
                const showEventModal = ref(false);
                const showEditModal = ref(false); 
                const newEventDate = ref('');
                const newEventLocation = ref('');
                const newSchedule = ref({ time: '09:00', location: '', description: '' });
                const newExpense = ref({ description: '', amount: 0 }); 
                const selectedFile = ref(null); 
                const isImporting = ref(false);
                const showImportModal = ref(false); 

                const editEventForm = ref({ eventName: '', artistName: '', date: '', mainLocation: '', id: null });

                // Computed
                const today = computed(() => new Date().toISOString().split('T')[0]);
                
                const getFanColorClass = (artistName) => {
                    const color = fanColors.value[artistName] || DEFAULT_COLOR_CLASS;
                    return color.startsWith('border-') ? color : `border-${color}`;
                };

                const applyTheme = (hexColor) => {
                    const root = document.documentElement.style;
                    const [r, g, b] = hexToRgb(hexColor);
                    root.setProperty('--theme-hex', hexColor);
                    root.setProperty('--theme-rgb', `${r}, ${g}, ${b}`);
                    currentAppThemeHex.value = hexColor;
                };

                const currentEvent = computed(() => events.value.find(e => e.id === activeEventId.value));
                const eventYears = computed(() => [...new Set(events.value.map(e => e.year))].sort((a, b) => b - a));
                const upcomingEvents = computed(() => events.value.filter(e => e.date && e.date >= today.value).sort((a, b) => a.date.localeCompare(b.date)));
                const pastEvents = computed(() => events.value.filter(e => e.date && e.date < today.value).sort((a, b) => b.date.localeCompare(a.date)));

                const mapLink = computed(() => {
                    const event = currentEvent.value;
                    if (!event) return null;
                    let locationToSearch = event.mainLocation || (event.dailyItems?.length > 0 ? event.dailyItems[event.dailyItems.length - 1].location : '');
                    return locationToSearch ? { url: `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(locationToSearch)}`, source: 'åœ°é»' } : null;
                });

                // Stats Logic
                const eventsInSelectedScope = computed(() => {
                    return events.value.filter(event => selectedReviewYear.value === 'all' || event.year === parseInt(selectedReviewYear.value)).sort((a, b) => b.date.localeCompare(a.date)); 
                });

                const overallStats = computed(() => {
                    const filteredEvents = eventsInSelectedScope.value;
                    const EXCLUDED_KEYWORDS = ['ì‚¬ì „ë…¹í™”', 'äº‹å‰éŒ„è£½', 'ç°½å”®æœƒ', 'ç°½åæœƒ', 'éŒ„è£½'];
                    const achievementList = filteredEvents.filter(event => !EXCLUDED_KEYWORDS.some(k => event.eventName?.includes(k)));
                    
                    let totalExpense = 0;
                    const artists = {};
                    
                    filteredEvents.forEach(e => {
                        totalExpense += e.expenses ? e.expenses.reduce((s, x) => s + x.amount, 0) : 0;
                    });
                    
                    achievementList.forEach(e => {
                        const artist = e.artistName || 'æœªçŸ¥';
                        artists[artist] = (artists[artist] || 0) + 1;
                    });

                    return {
                        totalEventsAll: filteredEvents.length,
                        totalEventsFiltered: achievementList.length,
                        uniqueArtists: Object.keys(artists).length,
                        artistBreakdown: Object.entries(artists).map(([name, count]) => ({ name, count })).sort((a, b) => b.count - a.count),
                        totalExpense: totalExpense.toFixed(0),
                        avgExpensePerEvent: filteredEvents.length > 0 ? (totalExpense / filteredEvents.length).toFixed(0) : 0
                    };
                });

                const expenseSummary = computed(() => {
                    const totalSpent = currentEvent.value?.expenses?.reduce((sum, exp) => sum + exp.amount, 0) || 0;
                    return { totalSpent: totalSpent.toFixed(0) };
                });

                // Firebase Operations
                const getEventCollectionRef = () => collection(db, `/artifacts/${appId}/users/${userId.value}/schedules`);
                const getColorDocRef = () => doc(db, `/artifacts/${appId}/users/${userId.value}/fan_colors/colors`);
                const getThemeDocRef = () => doc(db, `/artifacts/${appId}/users/${userId.value}/app_theme/theme`);

                const subscribeToEvents = () => {
                    if (unsubscribeEvents) unsubscribeEvents();
                    unsubscribeEvents = onSnapshot(getEventCollectionRef(), (snap) => {
                        events.value = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        loading.value = false;
                    });
                    onSnapshot(getColorDocRef(), (doc) => fanColors.value = doc.data() || {});
                    onSnapshot(getThemeDocRef(), (doc) => {
                        const hex = doc.data()?.hex || INITIAL_APP_THEME_HEX;
                        applyTheme(hex);
                        newThemeSelectionHex.value = hex;
                    });
                };

                const initFirebase = () => {
                    try {
                        if(firebaseConfig.apiKey === "YOUR_API_KEY") {
                            console.error("è«‹è¨­å®š Firebase Config");
                            alert("è«‹ç·¨è¼¯ HTML æª”æ¡ˆï¼Œå¡«å…¥æ‚¨çš„ Firebase Config!");
                            loading.value = false;
                            return;
                        }
                        app = initializeApp(firebaseConfig);
                        db = getFirestore(app);
                        auth = getAuth(app);
                        signInAnonymously(auth);
                        onAuthStateChanged(auth, (user) => {
                            if (user) { userId.value = user.uid; isAuthReady.value = true; subscribeToEvents(); }
                        });
                    } catch (e) { console.error(e); loading.value = false; }
                };

                // CRUD Actions
                const addEvent = async () => {
                    if (!newEventName.value || !newEventDate.value) return;
                    await addDoc(getEventCollectionRef(), {
                        eventName: newEventName.value, artistName: newArtistName.value, 
                        year: new Date(newEventDate.value).getFullYear(), date: newEventDate.value, 
                        mainLocation: newEventLocation.value, dailyItems: [], expenses: [], participants: ['æˆ‘']
                    });
                    showEventModal.value = false; newEventName.value = '';
                };

                const deleteEvent = async (id) => {
                    if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { await deleteDoc(doc(getEventCollectionRef(), id)); if (activeEventId.value === id) activeEventId.value = null; }
                };

                const addDailyItem = async () => {
                    if (!currentEvent.value) return;
                    const items = [...currentEvent.value.dailyItems, { ...newSchedule.value, id: crypto.randomUUID() }];
                    // Simple sort by time
                    items.sort((a,b) => a.time.localeCompare(b.time));
                    await updateDoc(doc(getEventCollectionRef(), activeEventId.value), { dailyItems: items });
                    newSchedule.value = { time: '09:00', location: '', description: '' };
                };

                const deleteDailyItem = async (itemId) => {
                    const items = currentEvent.value.dailyItems.filter(i => i.id !== itemId);
                    await updateDoc(doc(getEventCollectionRef(), activeEventId.value), { dailyItems: items });
                };

                const addExpense = async () => {
                    if (!currentEvent.value) return;
                    const exps = [...currentEvent.value.expenses, { ...newExpense.value, id: crypto.randomUUID() }];
                    await updateDoc(doc(getEventCollectionRef(), activeEventId.value), { expenses: exps });
                    newExpense.value = { description: '', amount: 0 };
                };

                const deleteExpense = async (eid) => {
                    const exps = currentEvent.value.expenses.filter(e => e.id !== eid);
                    await updateDoc(doc(getEventCollectionRef(), activeEventId.value), { expenses: exps });
                };

                // Colors & Theme
                const addOrUpdateColor = async () => {
                    if (!newColorArtist.value || !newColorClass.value) return;
                    await setDoc(getColorDocRef(), { [newColorArtist.value]: newColorClass.value }, { merge: true });
                    newColorArtist.value = '';
                };
                const deleteColor = async (artist) => {
                    const updated = { ...fanColors.value }; delete updated[artist];
                    await setDoc(getColorDocRef(), updated);
                };
                const saveAppTheme = async () => {
                    await setDoc(getThemeDocRef(), { hex: newThemeSelectionHex.value });
                    showColorModal.value = false;
                };

                // CSV Import
                const handleFileSelect = (e) => selectedFile.value = e.target.files[0];
                const convertDate = (d) => { if(d.length!==6) return null; return `20${d.substring(0,2)}-${d.substring(2,4)}-${d.substring(4,6)}`; };
                
                const importCSV = () => {
                    if (!selectedFile.value) return; isImporting.value = true;
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const lines = e.target.result.trim().split('\n').slice(1); // skip header
                        let count = 0;
                        for (const line of lines) {
                            // Simple CSV parse (assumes Date,Artist,Name,Loc order)
                            const cols = line.split(',');
                            if(cols.length >= 4) {
                                const date = convertDate(cols[0].trim());
                                if(date) {
                                    await addDoc(getEventCollectionRef(), {
                                        date, artistName: cols[1].trim(), eventName: cols[2].trim(), mainLocation: cols[3].trim(),
                                        year: new Date(date).getFullYear(), dailyItems: [], expenses: [], participants: ['æˆ‘']
                                    });
                                    count++;
                                }
                            }
                        }
                        alert(`æˆåŠŸåŒ¯å…¥ ${count} ç­†è¡Œç¨‹`); isImporting.value = false; showImportModal.value = false;
                    };
                    reader.readAsText(selectedFile.value);
                };

                // Edit Logic
                const loadEditForm = () => {
                    editEventForm.value = { ...currentEvent.value };
                    showEditModal.value = true;
                };
                const saveEditedEvent = async () => {
                    const { id, eventName, artistName, date, mainLocation } = editEventForm.value;
                    await updateDoc(doc(getEventCollectionRef(), id), { 
                        eventName, artistName, date, mainLocation, year: new Date(date).getFullYear() 
                    });
                    showEditModal.value = false;
                };

                initFirebase();

                return {
                    loading, isAuthReady, events, activeEventId, activeTab, selectedReviewYear,
                    currentEvent, upcomingEvents, pastEvents, eventYears, eventsInSelectedScope,
                    overallStats, expenseSummary, mapLink,
                    // Forms
                    newEventName, newArtistName, newEventDate, newEventLocation, 
                    showEventModal, showEditModal, showColorModal, showImportModal,
                    editEventForm, newSchedule, newExpense,
                    // Theme
                    fanColors, newColorArtist, newColorClass, newThemeSelectionHex, showExclusionDisclaimer,
                    // Actions
                    getFanColorClass, addEvent, deleteEvent, loadEditForm, saveEditedEvent,
                    addDailyItem, deleteDailyItem, addExpense, deleteExpense,
                    addOrUpdateColor, deleteColor, saveAppTheme,
                    handleFileSelect, importCSV, isImporting, selectedFile,
                    today,
                    setActiveEvent: (id) => { activeEventId.value = id; },
                    setActiveTab: (t) => activeTab.value = t,
                    goToEventList: () => { activeEventId.value = null; activeTab.value = 'schedule'; }
                };
            }
        };

        window.onload = () => { createApp(EventTracker).mount('#app'); };
    </script>
</body>
</html>
